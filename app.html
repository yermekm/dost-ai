<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Dost.AI">
<meta name="theme-color" content="#f5f0e8">
<meta name="description" content="–¢–≤–æ–π –¥—Ä—É–≥ –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø—Ä–∞–≤–∞–º, –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –∏ –ø–µ–Ω—Å–∏–∏">
<title>Dost AI ‚Äî Your friend in any situation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --paper: #fdfaf4;
  --dark: #1a1508;
  --ink: #2d2510;
  --accent: #c8922a;
  --accent2: #8b4513;
  --muted: #8a7d65;
  --border: #d4c9a8;
  --surface: #efe8d5;
  --surface2: #e8dfc8;
  --green: #2d5a27;
  --green2: #3d7a35;
  --amber: #b8760a;
  --blue: #2a4a8a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Lora', serif;
  min-height: 100vh;
}

body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.045'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:0;
}

.app { position:relative; z-index:1; display:flex; flex-direction:column; min-height:100vh; }

header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 28px;
  background:rgba(253,250,244,0.92);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:100;
}

.logo {
  font-family:'Playfair Display', serif;
  font-size:26px;
  font-weight:900;
  color:var(--dark);
  letter-spacing:-1px;
}
.logo span { color:var(--accent); }
.logo-tagline {
  font-family:'IBM Plex Mono', monospace;
  font-size:9px;
  color:var(--muted);
  letter-spacing:2px;
  margin-top:2px;
}

.header-right { display:flex; align-items:center; gap:14px; }

.lang-flags { display:flex; gap:5px; }
.lang-flag { font-size:18px; opacity:0.55; cursor:default; transition:opacity 0.15s; }
.lang-flag:hover { opacity:1; }

.multilang-badge {
  font-family:'IBM Plex Mono', monospace;
  font-size:9px;
  letter-spacing:1.5px;
  color:var(--green);
  background:rgba(45,90,39,0.08);
  border:1px solid rgba(45,90,39,0.2);
  padding:5px 10px;
  border-radius:20px;
}

.module-tabs {
  display:flex;
  gap:0;
  border-bottom:2px solid var(--border);
  background:var(--paper);
  overflow-x:auto;
  padding:0 28px;
}
.module-tabs::-webkit-scrollbar { display:none; }

.tab {
  display:flex;
  align-items:center;
  gap:8px;
  padding:14px 22px;
  border:none;
  background:none;
  color:var(--muted);
  font-family:'Lora', serif;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
  border-bottom:3px solid transparent;
  margin-bottom:-2px;
}
.tab:hover { color:var(--ink); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab.active.gt { color:var(--green); border-bottom-color:var(--green); }
.tab.active.at { color:var(--amber); border-bottom-color:var(--amber); }
.tab-icon { font-size:18px; }

.content {
  display:grid;
  grid-template-columns:260px 1fr;
  height:calc(100vh - 114px);
}

.sidebar {
  background:var(--paper);
  border-right:1px solid var(--border);
  padding:20px 12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:3px;
}
.sidebar::-webkit-scrollbar { width:3px; }
.sidebar::-webkit-scrollbar-thumb { background:var(--border); }

.sidebar-label {
  font-family:'IBM Plex Mono', monospace;
  font-size:9px;
  letter-spacing:3px;
  color:var(--muted);
  padding:10px 12px 6px;
}

.side-btn {
  display:flex;
  align-items:center;
  gap:10px;
  width:100%;
  padding:10px 12px;
  background:none;
  border:none;
  border-radius:8px;
  color:var(--muted);
  font-family:'Lora', serif;
  font-size:13px;
  cursor:pointer;
  transition:all 0.15s;
  text-align:left;
}
.side-btn:hover { background:var(--surface); color:var(--ink); }
.side-btn.sa { background:var(--surface2); color:var(--accent2); font-weight:600; }
.side-btn.sg { background:rgba(45,90,39,0.08); color:var(--green); font-weight:600; }
.side-btn.sam { background:rgba(184,118,10,0.08); color:var(--amber); font-weight:600; }

.chat-panel { display:flex; flex-direction:column; height:100%; }

.chat-messages {
  flex:1;
  overflow-y:auto;
  padding:28px;
  display:flex;
  flex-direction:column;
  gap:22px;
  background:var(--bg);
}
.chat-messages::-webkit-scrollbar { width:4px; }
.chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* Welcome */
.welcome {
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding:36px 24px;
  gap:14px;
  max-width:520px;
  margin:0 auto;
}
.welcome-emoji { font-size:52px; line-height:1; }
.welcome h2 {
  font-family:'Playfair Display', serif;
  font-size:24px;
  font-weight:900;
  color:var(--dark);
  line-height:1.25;
}
.welcome p { font-size:14px; color:var(--muted); line-height:1.75; }

.lang-notice {
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  background:rgba(45,90,39,0.06);
  border:1px solid rgba(45,90,39,0.18);
  border-radius:8px;
  font-size:12px;
  color:var(--green);
  font-family:'IBM Plex Mono', monospace;
  letter-spacing:0.5px;
  width:100%;
  max-width:420px;
}

.quick-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  width:100%;
  margin-top:4px;
}
.quick-card {
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:10px;
  padding:14px;
  cursor:pointer;
  transition:all 0.18s;
  text-align:left;
  font-family:'Lora', serif;
}
.quick-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 20px rgba(200,146,42,0.12); }
.quick-card.qg:hover { border-color:var(--green); box-shadow:0 6px 20px rgba(45,90,39,0.1); }
.quick-card.qa:hover { border-color:var(--amber); box-shadow:0 6px 20px rgba(184,118,10,0.1); }
.qc-icon { font-size:20px; margin-bottom:8px; }
.qc-text { font-size:12px; color:var(--muted); line-height:1.5; }

/* Messages */
.msg { display:flex; gap:12px; animation:fadeUp 0.25s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }
.msg.user { flex-direction:row-reverse; }

.avatar {
  width:36px; height:36px;
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
  border:1px solid var(--border);
}
.msg.ai .avatar { background:var(--paper); }
.msg.user .avatar { background:var(--accent); border-color:var(--accent); font-size:13px; font-family:'Playfair Display',serif; font-weight:900; color:#fff; }

.bubble {
  max-width:580px;
  padding:16px 20px;
  border-radius:14px;
  font-size:14px;
  line-height:1.75;
}
.msg.ai .bubble { background:var(--paper); border:1px solid var(--border); border-top-left-radius:3px; color:var(--ink); }
.msg.user .bubble { background:var(--accent); color:#fff; border-top-right-radius:3px; }

/* Image preview in user bubble */
.msg.user .bubble img { max-width:220px; border-radius:8px; display:block; margin-bottom:8px; opacity:0.9; }

.bubble h4 { font-family:'Playfair Display',serif; font-size:15px; font-weight:700; margin-bottom:10px; color:var(--dark); }
.bubble ul { padding-left:18px; margin:8px 0; }
.bubble li { margin-bottom:6px; }

.step-row { display:flex; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
.step-row:last-of-type { border-bottom:none; }
.sn { font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:500; min-width:22px; margin-top:2px; color:var(--accent); }
.sn.g { color:var(--green); }
.sn.a { color:var(--amber); }

.tag { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:5px; font-size:11px; font-family:'IBM Plex Mono',monospace; margin-top:8px; margin-right:5px; }
.tag.dl { background:rgba(184,118,10,0.1); color:var(--amber); border:1px solid rgba(184,118,10,0.25); }
.tag.inf { background:rgba(42,74,138,0.08); color:var(--blue); border:1px solid rgba(42,74,138,0.2); }
.tag.ok { background:rgba(45,90,39,0.08); color:var(--green); border:1px solid rgba(45,90,39,0.2); }

.doc-block {
  background:rgba(45,90,39,0.04);
  border:1px solid rgba(45,90,39,0.2);
  border-radius:10px;
  padding:16px; margin:12px 0;
  font-size:13px; line-height:1.9;
  white-space:pre-line; font-family:'Lora',serif;
}

.disclaimer {
  margin-top:12px; padding:10px 14px;
  background:rgba(138,125,101,0.07);
  border-left:3px solid var(--muted);
  border-radius:0 8px 8px 0;
  font-size:12px; color:var(--muted); font-style:italic; line-height:1.6;
}

/* Typing */
.typing { display:flex; gap:5px; align-items:center; padding:3px 0; }
.td { width:7px; height:7px; border-radius:50%; background:var(--accent); animation:bounce 1.2s ease-in-out infinite; }
.td:nth-child(2){animation-delay:0.2s;}
.td:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:0.3;}30%{transform:translateY(-7px);opacity:1;}}

/* Input area */
.input-area {
  padding:12px 28px 18px;
  border-top:1px solid var(--border);
  background:var(--paper);
}

/* Image preview before sending */
.img-preview-wrap {
  display:none;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:8px;
}
.img-preview-wrap.visible { display:flex; }
.img-preview-wrap img { height:52px; border-radius:6px; object-fit:cover; }
.img-preview-info { flex:1; }
.img-preview-name { font-size:12px; font-weight:600; color:var(--ink); }
.img-preview-sub { font-size:11px; color:var(--muted); font-family:'IBM Plex Mono',monospace; }
.img-remove {
  background:none; border:none; cursor:pointer;
  color:var(--muted); font-size:18px; line-height:1;
  transition:color 0.15s;
}
.img-remove:hover { color:var(--accent2); }

.input-row {
  display:flex;
  gap:8px;
  align-items:flex-end;
  background:var(--bg);
  border:1.5px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.input-row:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px rgba(200,146,42,0.08); }
.input-row.fc:focus-within { border-color:var(--green); box-shadow:0 0 0 3px rgba(45,90,39,0.07); }
.input-row.fa:focus-within { border-color:var(--amber); box-shadow:0 0 0 3px rgba(184,118,10,0.07); }

.input-row textarea {
  flex:1; background:none; border:none; outline:none;
  font-family:'Lora',serif; font-size:14px; color:var(--ink);
  resize:none; min-height:22px; max-height:110px; line-height:1.6;
}
.input-row textarea::placeholder { color:var(--muted); }

.upload-btn {
  background:none; border:none; cursor:pointer;
  color:var(--muted); font-size:20px; line-height:1;
  padding:6px; border-radius:7px;
  transition:all 0.15s; flex-shrink:0;
}
.upload-btn:hover { background:var(--surface); color:var(--accent); }

.send-btn {
  background:var(--dark); color:var(--accent);
  border:none; border-radius:8px;
  width:36px; height:36px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:17px;
  transition:all 0.15s; flex-shrink:0;
}
.send-btn:hover { background:var(--accent); color:#fff; }
.send-btn:disabled { opacity:0.35; cursor:not-allowed; }
.send-btn.g { background:var(--green); color:#fff; }
.send-btn.g:hover { background:var(--green2); }
.send-btn.a { background:var(--amber); color:#fff; }

.input-hints {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:7px;
  padding:0 2px;
}
.input-hint { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:0.5px; }
.lang-hint { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--green); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ‚Äî –ø–æ–ª–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:700px){

  /* Header ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
  header {
    padding: 10px 16px;
  }
  .logo { font-size: 22px; }
  .logo-tagline { display: none; }
  .multilang-badge { display: none; }
  .lang-flags { gap: 3px; }
  .lang-flag { font-size: 15px; }

  /* –¢–∞–±—ã ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, –∫—Ä—É–ø–Ω–µ–µ */
  .module-tabs { padding: 0 8px; }
  .tab {
    padding: 12px 14px;
    font-size: 13px;
    gap: 6px;
  }
  .tab-icon { font-size: 20px; }

  /* –õ–µ–π–∞—É—Ç ‚Äî —É–±–∏—Ä–∞–µ–º —Å–∞–π–¥–±–∞—Ä */
  .content {
    grid-template-columns: 1fr;
    height: calc(100vh - 108px);
  }
  .sidebar { display: none; }

  /* –ß–∞—Ç ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω */
  .chat-messages {
    padding: 16px 12px;
    gap: 16px;
  }

  /* Welcome —ç–∫—Ä–∞–Ω */
  .welcome { padding: 24px 12px; }
  .welcome-emoji { font-size: 44px; }
  .welcome h2 { font-size: 20px; }
  .welcome p { font-size: 13px; }
  .quick-grid {
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .quick-card { padding: 14px 10px; }
  .qc-icon { font-size: 24px; }
  .qc-text { font-size: 12px; }

  /* –°–æ–æ–±—â–µ–Ω–∏—è */
  .msg { gap: 8px; }
  .avatar {
    width: 30px;
    height: 30px;
    font-size: 14px;
    border-radius: 8px;
    flex-shrink: 0;
  }
  .bubble {
    font-size: 14px;
    padding: 12px 14px;
    max-width: calc(100vw - 80px);
  }

  /* –ò–Ω–ø—É—Ç ‚Äî —É–¥–æ–±–Ω–µ–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
  .input-area { padding: 10px 12px 14px; }
  .input-row { gap: 8px; border-radius: 14px; padding: 8px 8px 8px 14px; }
  #msgInput {
    font-size: 16px; /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
    min-height: 22px;
  }
  .send-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
    border-radius: 10px;
    flex-shrink: 0;
  }
  .upload-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
    flex-shrink: 0;
  }

  /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –≤–Ω–∏–∑—É */
  .input-hints { flex-direction: column; gap: 3px; }
  .lang-hint { font-size: 10px; }

  /* –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞ */
  .img-preview-box { padding: 8px 12px; border-radius: 10px; }
  .img-preview-thumb { width: 36px; height: 36px; }
  .img-preview-name { font-size: 11px; }

  /* –¢–µ–≥–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö AI */
  .tag { font-size: 11px; padding: 4px 8px; }
  .step-row { gap: 10px; }
  .sn { width: 26px; height: 26px; font-size: 11px; }

  /* Scroll to bottom —É–¥–æ–±–Ω–µ–µ */
  .bubble h4 { font-size: 14px; }
  .bubble ul { padding-left: 16px; }
}

/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media(max-width:380px){
  .quick-grid { grid-template-columns: 1fr; }
  .tab span:not(.tab-icon) { display: none; }
  .tab { padding: 12px 16px; }
}
</style>
</head>
<body>
<div class="app">

  <header>
    <div>
      <div class="logo">Dost<span>.</span>AI</div>
      <div class="logo-tagline">YOUR FRIEND IN ANY SITUATION</div>
    </div>
    <div class="header-right">
      <div class="multilang-badge">üåê MULTILINGUAL</div>
      <div class="lang-flags">
        <span class="lang-flag" title="Kazakhstan">üá∞üáø</span>
        <span class="lang-flag" title="Uzbekistan">üá∫üáø</span>
        <span class="lang-flag" title="Russia">üá∑üá∫</span>
        <span class="lang-flag" title="Turkey">üáπüá∑</span>
        <span class="lang-flag" title="Kyrgyzstan">üá∞üá¨</span>
        <span class="lang-flag" title="Azerbaijan">üá¶üáø</span>
        <span class="lang-flag" title="English">üá¨üáß</span>
      </div>
    </div>
  </header>

  <div class="module-tabs">
    <button class="tab active" data-mod="lex" onclick="switchModule('lex',this)">
      <span class="tab-icon">‚öñÔ∏è</span> <span data-i="rights">–ú–æ–∏ –ø—Ä–∞–≤–∞ / My Rights</span>
    </button>
    <button class="tab gt" data-mod="doc" onclick="switchModule('doc',this)">
      <span class="tab-icon">üìã</span> <span data-i="docs">–î–æ–∫—É–º–µ–Ω—Ç—ã / Documents</span>
    </button>
    <button class="tab at" data-mod="pension" onclick="switchModule('pension',this)">
      <span class="tab-icon">üë¥</span> <span data-i="pension">–ü–µ–Ω—Å–∏—è / Pension & Benefits</span>
    </button>
  </div>

  <div class="content">
    <div class="sidebar" id="sidebar"></div>
    <div class="chat-panel" id="chatPanel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="input-area">

        <!-- Image preview -->
        <div class="img-preview-wrap" id="imgPreview">
          <img id="imgPreviewThumb" src="" alt="preview">
          <div class="img-preview-info">
            <div class="img-preview-name" id="imgPreviewName">document.jpg</div>
            <div class="img-preview-sub" id="imgPreviewSub">üìé DOCUMENT ATTACHED ¬∑ AI WILL READ IT</div>
          </div>
          <button class="img-remove" onclick="removeImage()" title="Remove">‚úï</button>
        </div>

        <div class="input-row" id="inputRow">
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Attach file: PDF, Word, Excel, PowerPoint, Image, TXT">üìé</button>
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display:none" onchange="handleFile(event)">
          <textarea id="msgInput"
            placeholder="Ask anything in any language... / –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ... / Herhangi bir dilde sorun..."
            rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"
            oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">‚Üë</button>
        </div>

        <div class="input-hints">
          <span class="input-hint">Enter ‚Äî send ¬∑ Shift+Enter ‚Äî new line</span>
          <span class="lang-hint">üåê Any language ¬∑ üìé PDF ¬∑ üìù Word ¬∑ üìä Excel ¬∑ üìë PPT ¬∑ üñºÔ∏è Images</span>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const mods = {
  lex: {
    sendCls:'', inputCls:'', icon:'‚öñÔ∏è',
    title:'My Rights / –ú–æ–∏ –ø—Ä–∞–≤–∞',
    welcomeTitle:'Know Your Rights / –ó–Ω–∞–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–∞–≤–∞',
    welcomeText:'Ask about your rights in any situation ‚Äî fines, disputes, violations. Write in any language: English, Russian, Turkish, Uzbek...',
    quick:[
      {icon:'üöó', text:'Got a fine ‚Äî how to appeal? / –®—Ç—Ä–∞—Ñ ‚Äî –∫–∞–∫ –æ—Å–ø–æ—Ä–∏—Ç—å?', cls:''},
      {icon:'üíº', text:'Employer not paying salary / –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –Ω–µ –ø–ª–∞—Ç–∏—Ç', cls:'qg'},
      {icon:'üéì', text:'Need apostille for documents / –ù—É–∂–µ–Ω –∞–ø–æ—Å—Ç–∏–ª—å', cls:'qa'},
      {icon:'üè†', text:'Conflict with landlord / –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–µ–º', cls:''},
    ],
    topics:[
      {icon:'üöó', label:'Fines / –®—Ç—Ä–∞—Ñ—ã', q:'Help me with a traffic fine'},
      {icon:'üíº', label:'Labor / –¢—Ä—É–¥', q:'My employer is not paying my salary'},
      {icon:'üõí', label:'Consumer rights / –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å', q:'I want to return a product'},
      {icon:'üéì', label:'Documents / –î–æ–∫—É–º–µ–Ω—Ç—ã', q:'I need an apostille for my diploma, what should I do?'},
      {icon:'üè†', label:'Rental / –ê—Ä–µ–Ω–¥–∞', q:'I have a conflict with my landlord'},
      {icon:'üè¶', label:'Banking / –ë–∞–Ω–∫', q:'Problem with my bank'},
    ],
    saCls:'sa',
    system:`You are Dost AI ‚Äî a friendly legal rights assistant for people in Kazakhstan, Uzbekistan, Russia, Turkey and Central Asia.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in. If they write in English ‚Üí respond in English. Russian ‚Üí Russian. Turkish ‚Üí Turkish. Uzbek ‚Üí Uzbek. Mixed ‚Üí use the dominant language.

If the user uploads a document image, read it carefully and explain what it says and what they should do.

Format responses with HTML:
- <h4> for headings
- <ul><li> for lists
- Steps: <div class="step-row"><span class="sn">01</span><div>text</div></div>
- Deadlines: <div class="tag dl">‚è∞ Deadline: X days</div>
- Info: <div class="tag inf">‚ÑπÔ∏è text</div>
- Always end with: <div class="disclaimer">This information is for educational purposes. For official legal actions, please consult a licensed lawyer.</div>`
  },

  doc: {
    sendCls:'g', inputCls:'fc', icon:'üìã',
    title:'Documents / –î–æ–∫—É–º–µ–Ω—Ç—ã',
    welcomeTitle:"Let's Draft Your Document",
    welcomeText:"I'll help you write any complaint, application or letter ‚Äî ready to send. Upload a document photo and I'll explain it or help you respond.",
    quick:[
      {icon:'üìù', text:'Write a complaint to a bank', cls:''},
      {icon:'‚ö°', text:'Complaint about bad product / –ü—Ä–µ—Ç–µ–Ω–∑–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä', cls:'qg'},
      {icon:'üéì', text:'Apostille & diploma recognition', cls:'qa'},
      {icon:'‚úâÔ∏è', text:'Letter to employer / –ü–∏—Å—å–º–æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é', cls:''},
    ],
    topics:[
      {icon:'üè¶', label:'Bank complaint', q:'Help me write a complaint to a bank'},
      {icon:'üõí', label:'Product complaint', q:'Help me write a complaint about a defective product'},
      {icon:'üè¢', label:'Government application', q:'Help me write an application to a government office'},
      {icon:'üéì', label:'Apostille / Diploma', q:'Help me understand the apostille process for my diploma'},
      {icon:'üíº', label:'Letter to employer', q:'Help me write a letter to my employer'},
      {icon:'‚öñÔ∏è', label:'Legal claim', q:'Help me draft a legal claim'},
    ],
    saCls:'sg',
    system:`You are Dost AI ‚Äî a document drafting assistant for everyday people in Kazakhstan, Uzbekistan, Russia and Turkey.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in. English ‚Üí English. Russian ‚Üí Russian. Turkish ‚Üí Turkish. Uzbek ‚Üí Uzbek.

If the user uploads a document image, read it carefully, explain what it says in simple terms, and ask if they need help responding to it.

First ask clarifying questions if needed, then provide a ready-to-use document.

Format with HTML:
- <h4> for headings
- Ready document: <div class="doc-block">document text here</div>
- Steps: <div class="step-row"><span class="sn g">01</span><div>text</div></div>
- <div class="tag ok">‚úì text</div>
- End with: <div class="disclaimer">This template is for guidance only. For complex cases, please consult a lawyer.</div>`
  },

  pension: {
    sendCls:'a', inputCls:'fa', icon:'üë¥',
    title:'Pension & Benefits / –ü–µ–Ω—Å–∏—è',
    welcomeTitle:'Pension & Social Benefits',
    welcomeText:"I'll explain your pension rights, benefits and allowances. Upload a document from the pension fund and I'll explain what it means.",
    quick:[
      {icon:'üí∞', text:'What pension am I entitled to?', cls:'qa'},
      {icon:'üéÅ', text:'What benefits can I get? / –ö–∞–∫–∏–µ –ª—å–≥–æ—Ç—ã?', cls:''},
      {icon:'üìÖ', text:'When can I retire? / –ö–æ–≥–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é?', cls:'qg'},
      {icon:'üè•', text:'Medical benefits / –õ—å–≥–æ—Ç—ã –Ω–∞ –ª–µ—á–µ–Ω–∏–µ', cls:''},
    ],
    topics:[
      {icon:'üí∞', label:'Pension amount', q:'How is my pension calculated?'},
      {icon:'üìÖ', label:'Retirement age', q:'When can I retire?'},
      {icon:'üéÅ', label:'Benefits / –õ—å–≥–æ—Ç—ã', q:'What benefits are available for pensioners?'},
      {icon:'üè•', label:'Medical benefits', q:'What medical benefits am I entitled to?'},
      {icon:'üöå', label:'Transport & utilities', q:'What transport and utility benefits exist for pensioners?'},
      {icon:'üìã', label:'Required documents', q:'What documents do I need to apply for pension?'},
    ],
    saCls:'sam',
    system:`You are Dost AI ‚Äî a kind and patient pension & social benefits assistant for people in Kazakhstan.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in. English ‚Üí English. Russian ‚Üí Russian. Turkish ‚Üí Turkish. Uzbek ‚Üí Uzbek.

If the user uploads a document from the pension fund (ENPF or other), read it carefully and explain what it says in simple, friendly terms.

Topics: ENPF, basic pension, labor pension, social benefits, retirement age, required documents.

Format with HTML:
- <h4> for headings
- <ul><li> for lists
- Steps: <div class="step-row"><span class="sn a">01</span><div>text</div></div>
- Amounts: <div class="tag dl">üí∞ text</div>
- <div class="tag ok">‚úì text</div>
- End with: <div class="disclaimer">Amounts and conditions may change. For accurate information, please contact ENPF or your local service center.</div>`
  }
};

let cur = 'lex';
let messages = [];
let pendingImageBase64 = null;
let pendingImageName = '';
let pendingMediaType = 'image/jpeg';

function switchModule(mod, tabEl) {
  cur = mod;
  messages = [];
  pendingImageBase64 = null;
  pendingTextContent = null;
  document.getElementById('imgPreview').classList.remove('visible');

  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');

  const m = mods[mod];
  document.getElementById('sendBtn').className = 'send-btn ' + m.sendCls;
  document.getElementById('inputRow').className = 'input-row ' + m.inputCls;

  renderSidebar();
  renderWelcome();
}

function renderSidebar() {
  const m = mods[cur];
  const sb = document.getElementById('sidebar');
  sb.innerHTML = `<div class="sidebar-label">QUICK TOPICS</div>`;
  m.topics.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'side-btn';
    btn.innerHTML = `<span>${t.icon}</span>${t.label}`;
    btn.onclick = () => {
      document.querySelectorAll('.side-btn').forEach(b => b.className='side-btn');
      btn.classList.add(m.saCls);
      document.getElementById('msgInput').value = t.q;
      sendMsg();
    };
    sb.appendChild(btn);
  });
}

function renderWelcome() {
  const m = mods[cur];
  document.getElementById('chatMessages').innerHTML = `
    <div class="welcome">
      <div class="welcome-emoji">${m.icon}</div>
      <h2>${m.welcomeTitle}</h2>
      <p>${m.welcomeText}</p>
      <div class="lang-notice">
        üåê Write in any language ‚Äî I'll respond in the same one
      </div>
      <div class="quick-grid">
        ${m.quick.map(q=>`
          <div class="quick-card ${q.cls}" onclick="askQuick('${q.text.replace(/'/g,"\\'")}')">
            <div class="qc-icon">${q.icon}</div>
            <div class="qc-text">${q.text}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function askQuick(text) {
  document.getElementById('msgInput').value = text;
  sendMsg();
}

// File type helpers
const FILE_TYPES = {
  image:   { exts: ['jpg','jpeg','png','gif','webp'], icon: 'üñºÔ∏è', label: 'IMAGE', mode: 'image' },
  pdf:     { exts: ['pdf'],                           icon: 'üìÑ', label: 'PDF',   mode: 'pdf' },
  word:    { exts: ['doc','docx'],                    icon: 'üìù', label: 'WORD',  mode: 'text' },
  excel:   { exts: ['xls','xlsx'],                    icon: 'üìä', label: 'EXCEL', mode: 'text' },
  ppt:     { exts: ['ppt','pptx'],                    icon: 'üìë', label: 'PPT',   mode: 'text' },
  txt:     { exts: ['txt'],                           icon: 'üìÉ', label: 'TXT',   mode: 'text' },
};

function getFileType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  for (const [key, val] of Object.entries(FILE_TYPES)) {
    if (val.exts.includes(ext)) return { key, ...val };
  }
  return { key:'unknown', icon:'üìé', label:'FILE', mode:'text' };
}

let pendingTextContent = null; // for Word/Excel/TXT extracted text

// File handling
async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';

  const ftype = getFileType(file.name);
  pendingImageName = file.name;
  pendingTextContent = null;
  pendingImageBase64 = null;

  const svgIcon = (icon) => `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52"><rect width="52" height="52" rx="8" fill="%23c8922a" opacity="0.12"/><text x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" font-size="28">' + icon + '</text></svg>')}`;

  function showPreview(thumbSrc, sublabel) {
    document.getElementById('imgPreviewThumb').src = thumbSrc;
    document.getElementById('imgPreviewName').textContent = file.name;
    document.getElementById('imgPreviewSub').textContent = `${ftype.icon} ${ftype.label} ATTACHED ¬∑ AI WILL READ IT`;
    document.getElementById('imgPreview').classList.add('visible');
  }

  if (ftype.mode === 'image') {
    // Native image ‚Äî send as base64 image
    pendingMediaType = file.type || 'image/jpeg';
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      pendingImageBase64 = dataUrl.split(',')[1];
      showPreview(dataUrl);
    };
    reader.readAsDataURL(file);

  } else if (ftype.mode === 'pdf') {
    // PDF ‚Äî send as document
    pendingMediaType = 'application/pdf';
    const reader = new FileReader();
    reader.onload = ev => {
      pendingImageBase64 = ev.target.result.split(',')[1];
      showPreview(svgIcon('üìÑ'));
    };
    reader.readAsDataURL(file);

  } else if (ftype.key === 'word') {
    // Word ‚Äî extract text with mammoth
    const arrayBuf = await file.arrayBuffer();
    try {
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuf });
      pendingTextContent = result.value.slice(0, 8000); // limit
      pendingMediaType = 'text';
      showPreview(svgIcon('üìù'));
    } catch(err) {
      alert('Could not read Word file. Try saving as .docx');
    }

  } else if (ftype.key === 'excel') {
    // Excel ‚Äî extract with SheetJS
    const arrayBuf = await file.arrayBuffer();
    try {
      const wb = XLSX.read(arrayBuf, { type: 'array' });
      let text = '';
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        text += `[Sheet: ${name}]\n` + XLSX.utils.sheet_to_csv(ws) + '\n\n';
      });
      pendingTextContent = text.slice(0, 8000);
      pendingMediaType = 'text';
      showPreview(svgIcon('üìä'));
    } catch(err) {
      alert('Could not read Excel file.');
    }

  } else if (ftype.key === 'ppt') {
    // PowerPoint ‚Äî extract text with SheetJS (basic)
    const arrayBuf = await file.arrayBuffer();
    try {
      const wb = XLSX.read(arrayBuf, { type: 'array' });
      let text = wb.SheetNames.map(n => XLSX.utils.sheet_to_csv(wb.Sheets[n])).join('\n');
      pendingTextContent = ('[PowerPoint file: ' + file.name + ']\n' + text).slice(0, 8000);
      pendingMediaType = 'text';
      showPreview(svgIcon('üìë'));
    } catch(err) {
      // Fallback: just send filename info
      pendingTextContent = `[PowerPoint file attached: ${file.name}. Please note I could not fully parse this file, but the user wants help with it.]`;
      pendingMediaType = 'text';
      showPreview(svgIcon('üìë'));
    }

  } else if (ftype.key === 'txt') {
    const text = await file.text();
    pendingTextContent = text.slice(0, 8000);
    pendingMediaType = 'text';
    showPreview(svgIcon('üìÉ'));
  }
}

function removeImage() {
  pendingImageBase64 = null;
  pendingImageName = '';
  pendingMediaType = 'image/jpeg';
  pendingTextContent = null;
  document.getElementById('imgPreview').classList.remove('visible');
  document.getElementById('imgPreviewThumb').src = '';
}

function addMsg(role, html, imgSrc) {
  const chat = document.getElementById('chatMessages');
  const w = chat.querySelector('.welcome');
  if (w) w.remove();

  const div = document.createElement('div');
  div.className = 'msg ' + role;
  const av = role==='ai' ? mods[cur].icon : 'D';
  const imgHtml = (imgSrc && role==='user') ? `<img src="${imgSrc}" alt="document">` : '';
  div.innerHTML = `<div class="avatar">${av}</div><div class="bubble">${imgHtml}${html}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addTyping() {
  const chat = document.getElementById('chatMessages');
  const w = chat.querySelector('.welcome');
  if (w) w.remove();
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'typing-el';
  div.innerHTML = `<div class="avatar">${mods[cur].icon}</div><div class="bubble"><div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMsg() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text && !pendingImageBase64) return;

  const isPDF = pendingMediaType === 'application/pdf';
  const isImage = pendingImageBase64 && !isPDF;
  const isTextFile = pendingTextContent !== null;
  const hasFile = isPDF || isImage || isTextFile;

  const imgSrc = isImage ? `data:${pendingMediaType};base64,` + pendingImageBase64 : null;

  let fileLabel = '';
  if (isPDF) fileLabel = 'üìÑ PDF attached';
  else if (isImage) fileLabel = 'üñºÔ∏è Image attached';
  else if (isTextFile) fileLabel = `üìé ${pendingImageName} attached`;

  const displayText = text || (hasFile ? fileLabel + ' ‚Äî please read and explain' : '');
  if (!displayText) return;

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('sendBtn').disabled = true;

  addMsg('user', displayText, imgSrc);

  // Build message content for API
  let userContent;
  if (isPDF && pendingImageBase64) {
    userContent = [
      { type:'document', source:{ type:'base64', media_type:'application/pdf', data:pendingImageBase64 } },
      { type:'text', text: text || 'Please read this document carefully and explain what it says and what I should do.' }
    ];
  } else if (isImage) {
    userContent = [
      { type:'image', source:{ type:'base64', media_type: pendingMediaType, data:pendingImageBase64 } },
      { type:'text', text: text || 'Please read this document carefully and explain what it says and what I should do.' }
    ];
  } else if (isTextFile) {
    const filePrompt = text
      ? `${text}\n\n[File: ${pendingImageName}]\n${pendingTextContent}`
      : `Please read this file carefully and explain what it says and what I should do.\n\n[File: ${pendingImageName}]\n${pendingTextContent}`;
    userContent = filePrompt;
  } else {
    userContent = text;
  }

  // For history: store text-only version (no base64 image to avoid breaking history)
  const historyContent = text || 'I uploaded a document image for you to read and explain.';
  messages.push({ role:'user', content: historyContent });

  // Clear image
  removeImage();
  addTyping();

  try {
    // Build messages for THIS request: replace last user message with full content (image + text)
    const requestMessages = [
      ...messages.slice(0, -1),
      { role:'user', content: userContent }
    ];

    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system: mods[cur].system,
        messages: requestMessages
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);
    const reply = data.content?.[0]?.text || 'No response received.';

    // Store assistant reply in history
    messages.push({ role:'assistant', content: reply });

    document.getElementById('typing-el')?.remove();
    addMsg('ai', reply);

  } catch(e) {
    document.getElementById('typing-el')?.remove();
    addMsg('ai',`<p style="color:var(--muted)">‚ö†Ô∏è Error: ${e.message || 'Connection failed'}. Please try again.</p>`);
    // Remove failed user message from history
    messages.pop();
  }

  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

renderSidebar();
renderWelcome();
</script>
</body>
</html>
