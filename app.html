<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Dost.AI">
<meta name="theme-color" content="#f5f0e8">
<meta name="description" content="–¢–≤–æ–π –¥—Ä—É–≥ –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø—Ä–∞–≤–æ–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º">
<title>Dost AI ‚Äî Your friend in any situation</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1508'/><text y='72' x='50' text-anchor='middle' font-size='60'>‚öñÔ∏è</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1508'/><text y='72' x='50' text-anchor='middle' font-size='60'>‚öñÔ∏è</text></svg>">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --paper: #fdfaf4;
  --dark: #1a1508;
  --ink: #2d2510;
  --accent: #c8922a;
  --accent2: #8b4513;
  --muted: #8a7d65;
  --border: #d4c9a8;
  --surface: #efe8d5;
  --surface2: #e8dfc8;
  --green: #2d5a27;
  --green2: #3d7a35;
  --amber: #b8760a;
  --blue: #2a4a8a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Lora', serif;
  min-height: 100vh;
}

body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.045'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:0;
}

.app { position:relative; z-index:1; display:flex; flex-direction:column; height:100vh; overflow:hidden; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 28px;
  background:rgba(253,250,244,0.92);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:100;
}

.logo {
  font-family:'Playfair Display', serif;
  font-size:26px;
  font-weight:900;
  color:var(--dark);
  letter-spacing:-1px;
  text-decoration:none;
}
.logo span { color:var(--accent); }
.logo-tagline {
  font-family:'IBM Plex Mono', monospace;
  font-size:9px;
  color:var(--muted);
  letter-spacing:2px;
  margin-top:2px;
}

.header-right { display:flex; align-items:center; gap:10px; }

/* Language dropdown button */
.lang-selector {
  position: relative;
}

.lang-btn-main {
  display:flex;
  align-items:center;
  gap:6px;
  font-family:'IBM Plex Mono', monospace;
  font-size:11px;
  letter-spacing:1px;
  color:var(--ink);
  background:var(--surface);
  border:1px solid var(--border);
  padding:7px 12px;
  border-radius:8px;
  cursor:pointer;
  transition:all 0.15s;
}
.lang-btn-main:hover { border-color:var(--accent); color:var(--accent); }
.lang-arrow { font-size:9px; opacity:0.6; }

.lang-dropdown {
  display:none;
  position:absolute;
  top:calc(100% + 6px);
  right:0;
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 8px 24px rgba(26,21,8,0.12);
  overflow:hidden;
  min-width:160px;
  z-index:200;
}
.lang-dropdown.open { display:block; }

.lang-option {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
  cursor:pointer;
  font-family:'IBM Plex Mono', monospace;
  font-size:12px;
  color:var(--ink);
  transition:background 0.12s;
}
.lang-option:hover { background:var(--surface); }
.lang-option.active { background:rgba(200,146,42,0.08); color:var(--accent); font-weight:500; }

/* Auth buttons */
.btn-auth-outline {
  font-family:'IBM Plex Mono', monospace;
  font-size:11px;
  letter-spacing:1px;
  padding:7px 16px;
  border:1.5px solid var(--border);
  border-radius:8px;
  background:none;
  color:var(--ink);
  cursor:pointer;
  transition:all 0.15s;
}
.btn-auth-outline:hover { border-color:var(--accent); color:var(--accent); }

.btn-auth-primary {
  font-family:'IBM Plex Mono', monospace;
  font-size:11px;
  letter-spacing:1px;
  padding:7px 16px;
  border:none;
  border-radius:8px;
  background:var(--dark);
  color:var(--accent);
  cursor:pointer;
  transition:all 0.15s;
}
.btn-auth-primary:hover { background:var(--accent); color:#fff; }

/* ‚îÄ‚îÄ‚îÄ MODULE TABS ‚îÄ‚îÄ‚îÄ */
.module-tabs {
  display:flex;
  gap:0;
  border-bottom:2px solid var(--border);
  background:var(--paper);
  overflow-x:auto;
  padding:0 28px;
}
.module-tabs::-webkit-scrollbar { display:none; }

.tab {
  display:flex;
  align-items:center;
  gap:8px;
  padding:14px 22px;
  border:none;
  background:none;
  color:var(--muted);
  font-family:'Lora', serif;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
  border-bottom:3px solid transparent;
  margin-bottom:-2px;
}
.tab:hover { color:var(--ink); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab.active.gt { color:var(--green); border-bottom-color:var(--green); }
.tab.active.at { color:var(--amber); border-bottom-color:var(--amber); }

/* History tab pushed to right */
.tab-history { margin-left:auto; }
.tab-icon { font-size:18px; }

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.content {
  display:flex;
  flex-direction:column;
  flex:1;
  min-height:0;
  overflow:hidden;
}

.chat-panel { display:flex; flex-direction:column; height:100%; }

/* ‚îÄ‚îÄ‚îÄ CHAT MESSAGES ‚îÄ‚îÄ‚îÄ */
.chat-messages {
  flex:1;
  overflow-y:auto;
  padding:28px;
  display:flex;
  flex-direction:column;
  gap:22px;
  background:var(--bg);
  min-height:0;
}
.chat-messages::-webkit-scrollbar { width:4px; }
.chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* ‚îÄ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ‚îÄ */
.welcome {
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding:36px 24px;
  gap:14px;
  max-width:540px;
  margin:0 auto;
}
.welcome-emoji { font-size:52px; line-height:1; }
.welcome h2 {
  font-family:'Playfair Display', serif;
  font-size:24px;
  font-weight:900;
  color:var(--dark);
  line-height:1.25;
}
.welcome p { font-size:14px; color:var(--muted); line-height:1.75; }

.location-pill {
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(45,90,39,0.06);
  border:1px solid rgba(45,90,39,0.18);
  border-radius:20px;
  padding:5px 14px;
  font-family:'IBM Plex Mono', monospace;
  font-size:11px;
  color:var(--green);
  letter-spacing:0.5px;
}

.quick-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  width:100%;
  margin-top:4px;
}
.quick-card {
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:10px;
  padding:14px;
  cursor:pointer;
  transition:all 0.18s;
  text-align:left;
  font-family:'Lora', serif;
}
.quick-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 20px rgba(200,146,42,0.12); }
.quick-card.qg:hover { border-color:var(--green); box-shadow:0 6px 20px rgba(45,90,39,0.1); }
.quick-card.qa:hover { border-color:var(--amber); box-shadow:0 6px 20px rgba(184,118,10,0.1); }
.qc-icon { font-size:20px; margin-bottom:8px; }
.qc-text { font-size:12px; color:var(--muted); line-height:1.5; }

/* ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ */
.msg { display:flex; gap:12px; animation:fadeUp 0.25s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }
.msg.user { flex-direction:row-reverse; }

.avatar {
  width:36px; height:36px;
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
  border:1px solid var(--border);
}
.msg.ai .avatar { background:var(--paper); }
.msg.user .avatar { background:var(--accent); border-color:var(--accent); font-size:13px; font-family:'Playfair Display',serif; font-weight:900; color:#fff; }

.bubble {
  max-width:580px;
  padding:16px 20px;
  border-radius:14px;
  font-size:14px;
  line-height:1.75;
}
.msg.ai .bubble { background:var(--paper); border:1px solid var(--border); border-top-left-radius:3px; color:var(--ink); }
.msg.user .bubble { background:var(--accent); color:#fff; border-top-right-radius:3px; }
.msg.user .bubble img { max-width:220px; border-radius:8px; display:block; margin-bottom:8px; opacity:0.9; }

.bubble h4 { font-family:'Playfair Display',serif; font-size:15px; font-weight:700; margin-bottom:10px; color:var(--dark); }
.bubble ul { padding-left:18px; margin:8px 0; }
.bubble li { margin-bottom:6px; }

.step-row { display:flex; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
.step-row:last-of-type { border-bottom:none; }
.sn { font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:500; min-width:22px; margin-top:2px; color:var(--accent); }
.sn.g { color:var(--green); }
.sn.a { color:var(--amber); }

.tag { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:5px; font-size:11px; font-family:'IBM Plex Mono',monospace; margin-top:8px; margin-right:5px; }
.tag.dl { background:rgba(184,118,10,0.1); color:var(--amber); border:1px solid rgba(184,118,10,0.25); }
.tag.inf { background:rgba(42,74,138,0.08); color:var(--blue); border:1px solid rgba(42,74,138,0.2); }
.tag.ok { background:rgba(45,90,39,0.08); color:var(--green); border:1px solid rgba(45,90,39,0.2); }

/* Law reference tag */
.tag.law {
  background:rgba(200,146,42,0.08);
  color:var(--accent2);
  border:1px solid rgba(200,146,42,0.25);
  font-size:11px;
  display:inline-flex;
  align-items:center;
  gap:5px;
  padding:4px 10px;
  border-radius:5px;
  margin-top:8px;
  margin-right:5px;
  font-family:'IBM Plex Mono',monospace;
}
.tag.law a { color:inherit; text-decoration:underline; text-underline-offset:2px; }

.doc-block {
  background:rgba(45,90,39,0.04);
  border:1px solid rgba(45,90,39,0.2);
  border-radius:10px;
  padding:16px; margin:12px 0;
  font-size:13px; line-height:1.9;
  white-space:pre-line; font-family:'Lora',serif;
}

.disclaimer {
  margin-top:12px; padding:10px 14px;
  background:rgba(138,125,101,0.07);
  border-left:3px solid var(--muted);
  border-radius:0 8px 8px 0;
  font-size:12px; color:var(--muted); font-style:italic; line-height:1.6;
}

/* Typing indicator */
.typing { display:flex; gap:5px; align-items:center; padding:3px 0; }
.td { width:7px; height:7px; border-radius:50%; background:var(--accent); animation:bounce 1.2s ease-in-out infinite; }
.td:nth-child(2){animation-delay:0.2s;}
.td:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:0.3;}30%{transform:translateY(-7px);opacity:1;}}

/* ‚îÄ‚îÄ‚îÄ INPUT AREA ‚îÄ‚îÄ‚îÄ */
.input-area {
  padding:12px 28px 18px;
  border-bottom:1px solid var(--border);
  background:var(--paper);
}

.img-preview-wrap {
  display:none;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:8px;
}
.img-preview-wrap.visible { display:flex; }
.img-preview-wrap img { height:52px; border-radius:6px; object-fit:cover; }
.img-preview-info { flex:1; }
.img-preview-name { font-size:12px; font-weight:600; color:var(--ink); }
.img-preview-sub { font-size:11px; color:var(--muted); font-family:'IBM Plex Mono',monospace; }
.img-remove {
  background:none; border:none; cursor:pointer;
  color:var(--muted); font-size:18px; line-height:1;
  transition:color 0.15s;
}
.img-remove:hover { color:var(--accent2); }

.input-row {
  display:flex;
  gap:8px;
  align-items:flex-end;
  background:var(--bg);
  border:1.5px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.input-row:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px rgba(200,146,42,0.08); }
.input-row.fc:focus-within { border-color:var(--green); box-shadow:0 0 0 3px rgba(45,90,39,0.07); }
.input-row.fa:focus-within { border-color:var(--amber); box-shadow:0 0 0 3px rgba(184,118,10,0.07); }

.input-row textarea {
  flex:1; background:none; border:none; outline:none;
  font-family:'Lora',serif; font-size:14px; color:var(--ink);
  resize:none; min-height:22px; max-height:110px; line-height:1.6;
}
.input-row textarea::placeholder { color:var(--muted); }

.upload-btn {
  background:none; border:none; cursor:pointer;
  color:var(--muted); font-size:20px; line-height:1;
  padding:6px; border-radius:7px;
  transition:all 0.15s; flex-shrink:0;
}
.upload-btn:hover { background:var(--surface); color:var(--accent); }

.send-btn {
  background:var(--dark); color:var(--accent);
  border:none; border-radius:8px;
  width:36px; height:36px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:17px;
  transition:all 0.15s; flex-shrink:0;
}
.send-btn:hover { background:var(--accent); color:#fff; }
.send-btn:disabled { opacity:0.35; cursor:not-allowed; }
.send-btn.g { background:var(--green); color:#fff; }
.send-btn.g:hover { background:var(--green2); }
.send-btn.a { background:var(--amber); color:#fff; }

.input-hints {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:7px;
  padding:0 2px;
}
.input-hint { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:0.5px; }
.disclaimer-hint { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); font-style:italic; }

/* ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ */
.history-panel {
  display:none;
  position:fixed;
  top:111px;
  right:0;
  width:300px;
  height:calc(100vh - 111px);
  background:var(--paper);
  border-left:1px solid var(--border);
  z-index:50;
  flex-direction:column;
  padding:16px;
  overflow-y:auto;
  box-shadow:-4px 0 16px rgba(26,21,8,0.08);
}
.history-panel.open { display:flex; }
.history-title {
  font-family:'IBM Plex Mono',monospace;
  font-size:10px;
  letter-spacing:3px;
  color:var(--muted);
  margin-bottom:16px;
}
.history-empty {
  font-size:13px;
  color:var(--muted);
  text-align:center;
  margin-top:32px;
  line-height:1.7;
}
.history-login-prompt {
  margin-top:16px;
  padding:14px;
  background:rgba(200,146,42,0.06);
  border:1px solid rgba(200,146,42,0.2);
  border-radius:10px;
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
  text-align:center;
}
.history-login-prompt a {
  color:var(--accent);
  cursor:pointer;
  text-decoration:underline;
}
.history-item {
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  margin-bottom:8px;
  cursor:pointer;
  transition:all 0.15s;
}
.history-item:hover { border-color:var(--accent); background:var(--surface); }
.history-item-title { font-size:13px; color:var(--ink); font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.history-item-date { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); margin-top:3px; }

/* ‚îÄ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(26,21,8,0.5);
  z-index:300;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.open { display:flex; }

.modal {
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:20px;
  padding:36px;
  width:100%;
  max-width:400px;
  box-shadow:0 24px 64px rgba(26,21,8,0.2);
  position:relative;
}

.modal-close {
  position:absolute;
  top:16px; right:16px;
  background:none; border:none;
  font-size:20px; color:var(--muted);
  cursor:pointer; line-height:1;
}
.modal-close:hover { color:var(--ink); }

.modal-logo {
  font-family:'Playfair Display', serif;
  font-size:22px;
  font-weight:900;
  color:var(--dark);
  margin-bottom:4px;
}
.modal-logo span { color:var(--accent); }

.modal-subtitle {
  font-family:'IBM Plex Mono',monospace;
  font-size:10px;
  letter-spacing:2px;
  color:var(--muted);
  margin-bottom:24px;
}

.modal-tabs {
  display:flex;
  gap:0;
  border-bottom:2px solid var(--border);
  margin-bottom:24px;
}
.modal-tab {
  flex:1;
  padding:10px;
  border:none;
  background:none;
  font-family:'Lora',serif;
  font-size:14px;
  font-weight:600;
  color:var(--muted);
  cursor:pointer;
  border-bottom:2px solid transparent;
  margin-bottom:-2px;
  transition:all 0.15s;
}
.modal-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

.modal-form { display:flex; flex-direction:column; gap:12px; }

.form-input {
  width:100%;
  padding:12px 14px;
  border:1.5px solid var(--border);
  border-radius:10px;
  background:var(--bg);
  font-family:'Lora',serif;
  font-size:14px;
  color:var(--ink);
  outline:none;
  transition:border-color 0.2s;
}
.form-input:focus { border-color:var(--accent); }
.form-input::placeholder { color:var(--muted); }

.btn-google {
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:12px;
  border:1.5px solid var(--border);
  border-radius:10px;
  background:white;
  font-family:'Lora',serif;
  font-size:14px;
  color:var(--ink);
  cursor:pointer;
  transition:all 0.15s;
}
.btn-google:hover { border-color:var(--accent); box-shadow:0 2px 8px rgba(0,0,0,0.08); }

.divider {
  display:flex;
  align-items:center;
  gap:12px;
  font-family:'IBM Plex Mono',monospace;
  font-size:10px;
  color:var(--muted);
  letter-spacing:1px;
}
.divider::before, .divider::after {
  content:'';
  flex:1;
  height:1px;
  background:var(--border);
}

.btn-submit {
  width:100%;
  padding:13px;
  border:none;
  border-radius:10px;
  background:var(--dark);
  color:var(--accent);
  font-family:'IBM Plex Mono',monospace;
  font-size:12px;
  letter-spacing:2px;
  cursor:pointer;
  transition:all 0.15s;
}
.btn-submit:hover { background:var(--accent); color:#fff; }

/* ‚îÄ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ‚îÄ */
@media(max-width:700px){
  header { padding:10px 16px; }
  .logo { font-size:22px; }
  .logo-tagline { display:none; }
  .module-tabs { padding:0 8px; }
  .tab { padding:12px 14px; font-size:13px; gap:6px; }
  .tab-icon { font-size:20px; }
  .content { height:auto; flex:1; min-height:0; }
  .chat-messages { padding:16px 12px; gap:16px; }
  .welcome { padding:24px 12px; }
  .welcome-emoji { font-size:44px; }
  .welcome h2 { font-size:20px; }
  .welcome p { font-size:13px; }
  .quick-grid { grid-template-columns:1fr 1fr; gap:8px; }
  .quick-card { padding:14px 10px; }
  .qc-icon { font-size:24px; }
  .qc-text { font-size:12px; }
  .msg { gap:8px; }
  .avatar { width:30px; height:30px; font-size:14px; border-radius:8px; flex-shrink:0; }
  .bubble { font-size:14px; padding:12px 14px; max-width:calc(100vw - 80px); }
  .input-area { padding:10px 12px 14px; }
  .input-row { gap:8px; border-radius:14px; padding:8px 8px 8px 14px; }
  #msgInput { font-size:16px; min-height:22px; }
  .send-btn { width:40px; height:40px; font-size:18px; border-radius:10px; flex-shrink:0; }
  .upload-btn { width:40px; height:40px; font-size:18px; flex-shrink:0; }
  .input-hints { flex-direction:column; gap:3px; }
  .header-right { gap:6px; }
  .btn-auth-outline { display:none; }
  .history-panel { width:100%; top:108px; height:calc(100vh - 108px); }
}

@media(max-width:380px){
  .quick-grid { grid-template-columns:1fr; }
  .tab span:not(.tab-icon) { display:none; }
  .tab { padding:12px 16px; }
}
</style>
</head>
<body>
<div class="app">

  <!-- ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ -->
  <header>
    <div>
      <a href="/" class="logo">Dost<span>.</span>AI</a>
      <div class="logo-tagline">YOUR FRIEND IN ANY SITUATION</div>
    </div>
    <div class="header-right">

      <!-- Language selector -->
      <div class="lang-selector" id="langSelector">
        <button class="lang-btn-main" onclick="toggleLangDropdown()">
          üåê <span id="langLabel">RU</span> <span class="lang-arrow">‚ñæ</span>
        </button>
        <div class="lang-dropdown" id="langDropdown">
          <div class="lang-option active" onclick="setUILang('ru','RU','–†—É—Å—Å–∫–∏–π')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
          <div class="lang-option" onclick="setUILang('en','EN','English')">üá¨üáß English</div>
          <div class="lang-option" onclick="setUILang('kz','“ö–ê–ó','“ö–∞–∑–∞“õ—à–∞')">üá∞üáø “ö–∞–∑–∞“õ—à–∞</div>
          <div class="lang-option" onclick="setUILang('tr','TR','T√ºrk√ße')">üáπüá∑ T√ºrk√ße</div>
        </div>
      </div>

      <button class="btn-auth-outline" onclick="openAuth('login')" id="loginBtn" data-i="login">–í–æ–π—Ç–∏</button>
      <button class="btn-auth-primary" onclick="openAuth('register')" id="registerBtn" data-i="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ‚îÄ MODULE TABS ‚îÄ‚îÄ‚îÄ -->
  <div class="module-tabs">
    <button class="tab active" data-mod="lex" onclick="switchModule('lex',this)">
      <span class="tab-icon">‚öñÔ∏è</span> <span data-i="tabRights">–ú–æ–∏ –ø—Ä–∞–≤–∞</span>
    </button>
    <button class="tab gt" data-mod="doc" onclick="switchModule('doc',this)">
      <span class="tab-icon">üíº</span> <span data-i="tabLabor">–¢—Ä—É–¥</span>
    </button>
    <button class="tab" data-mod="rental" onclick="switchModule('rental',this)">
      <span class="tab-icon">üè†</span> <span data-i="tabRental">–ê—Ä–µ–Ω–¥–∞</span>
    </button>
    <button class="tab" data-mod="fines" onclick="switchModule('fines',this)">
      <span class="tab-icon">üöó</span> <span data-i="tabFines">–®—Ç—Ä–∞—Ñ—ã</span>
    </button>
    <button class="tab" data-mod="banking" onclick="switchModule('banking',this)">
      <span class="tab-icon">üè¶</span> <span data-i="tabBanking">–ë–∞–Ω–∫–∏</span>
    </button>
    <button class="tab" data-mod="consumer" onclick="switchModule('consumer',this)">
      <span class="tab-icon">üë§</span> <span data-i="tabConsumer">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å</span>
    </button>
    <button class="tab tab-history" onclick="toggleHistory()">
      <span class="tab-icon">üïê</span> <span data-i="tabHistory">–ò—Å—Ç–æ—Ä–∏—è</span>
    </button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ -->
  <div class="content">
    <div class="chat-panel" id="chatPanel">

      <div class="input-area">
        <!-- File preview -->
        <div class="img-preview-wrap" id="imgPreview">
          <img id="imgPreviewThumb" src="" alt="preview">
          <div class="img-preview-info">
            <div class="img-preview-name" id="imgPreviewName">document.jpg</div>
            <div class="img-preview-sub" id="imgPreviewSub">üìé –î–û–ö–£–ú–ï–ù–¢ –ü–†–ò–ö–†–ï–ü–õ–Å–ù</div>
          </div>
          <button class="img-remove" onclick="removeImage()" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>

        <div class="input-row" id="inputRow">
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
          <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display:none" onchange="handleFile(event)">
          <textarea id="msgInput"
            placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."
            rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"
            oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">‚Üë</button>
        </div>

        <div class="input-hints">
          <span class="input-hint">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</span>
          <span class="disclaimer-hint" data-i="disclaimer">‚ö†Ô∏è –î–æ—Å—Ç –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —é—Ä–∏—Å—Ç–∞</span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages"></div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ -->
  <div class="history-panel" id="historyPanel">
    <div class="history-title" data-i="historyTitle">–ò–°–¢–û–†–ò–Ø –ß–ê–¢–û–í</div>
    <div id="historyContent"></div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ -->
  <div style="
    position:fixed; bottom:0; left:0; right:0;
    text-align:center;
    font-family:'IBM Plex Mono',monospace;
    font-size:10px;
    letter-spacing:1px;
    color:var(--muted);
    padding:4px;
    pointer-events:none;
    z-index:10;
    opacity:0.5;
  ">Created by YM &amp; C</div>

</div>

<!-- ‚îÄ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="modal-overlay" id="authModal">
  <div class="modal">
    <button class="modal-close" onclick="closeAuth()">‚úï</button>
    <div class="modal-logo">Dost<span>.</span>AI</div>
    <div class="modal-subtitle" data-i="modalSubtitle">–°–û–•–†–ê–ù–Ø–ô–¢–ï –ò–°–¢–û–†–ò–Æ –ß–ê–¢–û–í</div>

    <div class="modal-tabs">
      <button class="modal-tab active" id="tabLogin" onclick="switchAuthTab('login')" data-i="login">–í–æ–π—Ç–∏</button>
      <button class="modal-tab" id="tabRegister" onclick="switchAuthTab('register')" data-i="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- Login form -->
    <div id="formLogin" class="modal-form">
      <button class="btn-google" onclick="authWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
        <span data-i="googleLogin">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
      </button>
      <div class="divider" data-i="or">–∏–ª–∏</div>
      <input class="form-input" type="email" placeholder="Email" id="loginEmail">
      <input class="form-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" id="loginPassword">
      <button class="btn-submit" onclick="authWithEmail('login')" data-i="loginBtn">–í–û–ô–¢–ò ‚Üí</button>
    </div>

    <!-- Register form -->
    <div id="formRegister" class="modal-form" style="display:none">
      <button class="btn-google" onclick="authWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
        <span data-i="googleRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google</span>
      </button>
      <div class="divider" data-i="or">–∏–ª–∏</div>
      <input class="form-input" type="email" placeholder="Email" id="regEmail">
      <input class="form-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" id="regPassword">
      <button class="btn-submit" onclick="authWithEmail('register')" data-i="registerBtn">–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø ‚Üí</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UI_LANGS = {
  ru: {
    login: '–í–æ–π—Ç–∏', register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
    tabRights: '–ú–æ–∏ –ø—Ä–∞–≤–∞', tabLabor: '–¢—Ä—É–¥', tabRental: '–ê—Ä–µ–Ω–¥–∞',
    tabFines: '–®—Ç—Ä–∞—Ñ—ã', tabBanking: '–ë–∞–Ω–∫–∏', tabConsumer: '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å',
    tabHistory: '–ò—Å—Ç–æ—Ä–∏—è',
    disclaimer: '‚ö†Ô∏è –î–æ—Å—Ç –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —é—Ä–∏—Å—Ç–∞',
    historyTitle: '–ò–°–¢–û–†–ò–Ø –ß–ê–¢–û–í',
    modalSubtitle: '–°–û–•–†–ê–ù–Ø–ô–¢–ï –ò–°–¢–û–†–ò–Æ –ß–ê–¢–û–í',
    googleLogin: '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google',
    googleRegister: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google',
    loginBtn: '–í–û–ô–¢–ò ‚Üí', registerBtn: '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø ‚Üí',
    or: '–∏–ª–∏',
    placeholder: '–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å...',
    langNotice: 'üåê –ü–∏—à–∏—Ç–µ –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ ‚Äî –æ—Ç–≤–µ—á—É –Ω–∞ —Ç–æ–º –∂–µ',
    historyEmpty: '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.\n–í–∞—à–∏ —á–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.',
    historyLoginPrompt: '–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å,\n—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.',
    historyLoginLink: '–í–æ–π—Ç–∏',
    enterHint: 'Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞',
  },
  en: {
    login: 'Login', register: 'Sign up',
    tabRights: 'My Rights', tabLabor: 'Labor', tabRental: 'Rental',
    tabFines: 'Fines', tabBanking: 'Banking', tabConsumer: 'Consumer',
    tabHistory: 'History',
    disclaimer: '‚ö†Ô∏è Dost does not replace a professional lawyer',
    historyTitle: 'CHAT HISTORY',
    modalSubtitle: 'SAVE YOUR CHAT HISTORY',
    googleLogin: 'Continue with Google',
    googleRegister: 'Sign up with Google',
    loginBtn: 'LOGIN ‚Üí', registerBtn: 'SIGN UP ‚Üí',
    or: 'or',
    placeholder: 'Ask anything...',
    langNotice: 'üåê Write in any language ‚Äî I\'ll respond in the same one',
    historyEmpty: 'No history yet.\nYour chats will appear here.',
    historyLoginPrompt: 'Login or register to save history\nacross all your devices.',
    historyLoginLink: 'Login',
    enterHint: 'Enter ‚Äî send ¬∑ Shift+Enter ‚Äî new line',
  },
  kz: {
    login: '–ö—ñ—Ä—É', register: '–¢—ñ—Ä–∫–µ–ª—É',
    tabRights: '–ú–µ–Ω—ñ“£ “õ“±“õ—ã“õ—Ç–∞—Ä—ã–º', tabLabor: '–ï“£–±–µ–∫', tabRental: '–ñ–∞–ª–¥–∞–º',
    tabFines: '–ê–π—ã–ø–ø“±–ª–¥–∞—Ä', tabBanking: '–ë–∞–Ω–∫—Ç–µ—Ä', tabConsumer: '–¢“±—Ç—ã–Ω—É—à—ã',
    tabHistory: '–¢–∞—Ä–∏—Ö',
    disclaimer: '‚ö†Ô∏è –î–æ—Å—Ç –∫”ô—Å—ñ–±–∏ –∑–∞“£–≥–µ—Ä–¥—ñ –∞–ª–º–∞—Å—Ç—ã—Ä–º–∞–π–¥—ã',
    historyTitle: '–ß–ê–¢ –¢–ê–†–ò–•–´',
    modalSubtitle: '–¢–ê–†–ò–•–´“¢–´–ó–î–´ –°–ê“ö–¢–ê“¢–´–ó',
    googleLogin: 'Google –∞—Ä“õ—ã–ª—ã –∫—ñ—Ä—É',
    googleRegister: 'Google –∞—Ä“õ—ã–ª—ã —Ç—ñ—Ä–∫–µ–ª—É',
    loginBtn: '–ö–Ü–†–£ ‚Üí', registerBtn: '–¢–Ü–†–ö–ï–õ–£ ‚Üí',
    or: '–Ω–µ–º–µ—Å–µ',
    placeholder: '–°“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑...',
    langNotice: 'üåê –ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç—ñ–ª–¥–µ –∂–∞–∑—ã“£—ã–∑ ‚Äî —Å–æ–ª —Ç—ñ–ª–¥–µ –∂–∞—É–∞–ø –±–µ—Ä–µ–º—ñ–Ω',
    historyEmpty: '–¢–∞—Ä–∏—Ö –∂–æ“õ.\n–°—ñ–∑–¥—ñ“£ —á–∞—Ç—Ç–∞—Ä—ã“£—ã–∑ –æ—Å—ã–Ω–¥–∞ –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã.',
    historyLoginPrompt: '–¢–∞—Ä–∏—Ö—Ç—ã —Å–∞“õ—Ç–∞—É “Ø—à—ñ–Ω –∫—ñ—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ —Ç—ñ—Ä–∫–µ–ª—ñ“£—ñ–∑.',
    historyLoginLink: '–ö—ñ—Ä—É',
    enterHint: 'Enter ‚Äî –∂—ñ–±–µ—Ä—É ¬∑ Shift+Enter ‚Äî –∂–∞“£–∞ –∂–æ–ª',
  },
  tr: {
    login: 'Giri≈ü', register: 'Kayƒ±t ol',
    tabRights: 'Haklarƒ±m', tabLabor: 'Emek', tabRental: 'Kiralƒ±k',
    tabFines: 'Cezalar', tabBanking: 'Bankacƒ±lƒ±k', tabConsumer: 'T√ºketici',
    tabHistory: 'Ge√ßmi≈ü',
    disclaimer: '‚ö†Ô∏è Dost profesyonel bir avukatƒ±n yerini tutmaz',
    historyTitle: 'SOHBET GE√áMƒ∞≈ûƒ∞',
    modalSubtitle: 'SOHBET GE√áMƒ∞≈ûƒ∞Nƒ∞Zƒ∞ KAYDEDIN',
    googleLogin: 'Google ile giri≈ü',
    googleRegister: 'Google ile kayƒ±t ol',
    loginBtn: 'Gƒ∞Rƒ∞≈û ‚Üí', registerBtn: 'KAYIT OL ‚Üí',
    or: 'veya',
    placeholder: 'Soru sorun...',
    langNotice: 'üåê Herhangi bir dilde yazƒ±n ‚Äî aynƒ± dilde yanƒ±t vereceƒüim',
    historyEmpty: 'Hen√ºz ge√ßmi≈ü yok.\nSohbetleriniz burada g√∂r√ºnecek.',
    historyLoginPrompt: 'Ge√ßmi≈üi kaydetmek i√ßin giri≈ü yapƒ±n veya kayƒ±t olun.',
    historyLoginLink: 'Giri≈ü',
    enterHint: 'Enter ‚Äî g√∂nder ¬∑ Shift+Enter ‚Äî yeni satƒ±r',
  }
};

let uiLang = 'ru';

function setUILang(lang, label, fullName) {
  uiLang = lang;
  document.getElementById('langLabel').textContent = label;
  document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('langDropdown').classList.remove('open');

  const t = UI_LANGS[lang];
  // Update all data-i elements
  document.querySelectorAll('[data-i]').forEach(el => {
    const key = el.getAttribute('data-i');
    if (t[key]) el.textContent = t[key];
  });
  // Placeholder
  document.getElementById('msgInput').placeholder = t.placeholder;
  // Re-render welcome
  renderWelcome();
}

function toggleLangDropdown() {
  document.getElementById('langDropdown').classList.toggle('open');
}
// Close dropdown on outside click
document.addEventListener('click', e => {
  if (!document.getElementById('langSelector').contains(e.target)) {
    document.getElementById('langDropdown').classList.remove('open');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOLOCATION ‚Äî detect user country
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let userCountry = 'KZ'; // default Kazakhstan
let userCountryName = '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω';

async function detectCountry() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    if (data.country_code) {
      userCountry = data.country_code;
      userCountryName = data.country_name || data.country_code;
    }
  } catch(e) {
    // fallback to KZ
  }
  renderWelcome();
}
detectCountry();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const mods = {
  lex: {
    sendCls:'', inputCls:'', icon:'‚öñÔ∏è',
    getTitle: () => UI_LANGS[uiLang].tabRights,
    getWelcomeTitle: () => ({ ru:'–ó–Ω–∞–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–∞–≤–∞', en:'Know Your Rights', kz:'“ö“±“õ—ã“õ—Ç–∞—Ä—ã“£—ã–∑–¥—ã –±—ñ–ª—ñ“£—ñ–∑', tr:'Haklarƒ±nƒ±zƒ± Bilin' })[uiLang] || 'Know Your Rights',
    getWelcomeText: () => ({ ru:'–î–æ—Å—Ç –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ª—é–±–æ–π –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è ‚Äî –≥–¥–µ –±—ã –≤—ã –Ω–∏ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å. –ü—Ä–∞–≤–∞ –Ω–∞ —Ä–∞–±–æ—Ç–µ, —Å–ø–æ—Ä—ã —Å –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–µ–º, —à—Ç—Ä–∞—Ñ—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ.', en:'Dost will help you navigate any life situation from a legal perspective ‚Äî wherever you are. Work rights, landlord disputes, fines, documents ‚Äî ask in any language.', kz:'–î–æ—Å—Ç –∫–µ–∑ –∫–µ–ª–≥–µ–Ω ”©–º—ñ—Ä–ª—ñ–∫ –∂–∞“ì–¥–∞–π–¥—ã –∑–∞“£–¥—ã“õ —Ç“±—Ä“ì—ã–¥–∞–Ω —à–µ—à—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–¥—ñ. –ñ“±–º—ã—Å “õ“±“õ—ã“õ—Ç–∞—Ä—ã, –∂–∞–ª“ì–∞ –∞–ª—É –¥–∞—É—ã, –∞–π—ã–ø–ø“±–ª–¥–∞—Ä ‚Äî –∫–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç—ñ–ª–¥–µ —Å“±—Ä–∞“£—ã–∑.', tr:'Dost, d√ºnyanƒ±n her yerinde hukuki a√ßƒ±dan her durumda size yardƒ±mcƒ± olacak. ƒ∞≈ü haklarƒ±, kiracƒ± anla≈ümazlƒ±klarƒ±, para cezalarƒ± ‚Äî herhangi bir dilde sorun.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üöó', text:{ru:'–®—Ç—Ä–∞—Ñ ‚Äî –∫–∞–∫ –æ—Å–ø–æ—Ä–∏—Ç—å?', en:'Got a fine ‚Äî how to appeal?', kz:'–ê–π—ã–ø–ø“±–ª ‚Äî “õ–∞–ª–∞–π –¥–∞—É–ª–∞—Å—É?', tr:'Ceza ‚Äî nasƒ±l itiraz edilir?'}, cls:''},
      {icon:'üíº', text:{ru:'–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –Ω–µ –ø–ª–∞—Ç–∏—Ç –∑–∞—Ä–ø–ª–∞—Ç—É', en:'Employer not paying salary', kz:'–ñ“±–º—ã—Å –±–µ—Ä—É—à—ñ –∂–∞–ª–∞“õ—ã —Ç”©–ª–µ–º–µ–π–¥—ñ', tr:'ƒ∞≈üveren maa≈ü √∂demiyor'}, cls:'qg'},
      {icon:'üéì', text:{ru:'–ù—É–∂–µ–Ω –∞–ø–æ—Å—Ç–∏–ª—å –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã', en:'Need apostille for documents', kz:'“ö“±–∂–∞—Ç—Ç–∞—Ä“ì–∞ –∞–ø–æ—Å—Ç–∏–ª—å –∫–µ—Ä–µ–∫', tr:'Belgeler i√ßin apostil gerekiyor'}, cls:'qa'},
      {icon:'üè†', text:{ru:'–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–µ–º', en:'Conflict with landlord', kz:'–ñ–∞–ª“ì–∞ –±–µ—Ä—É—à—ñ–º–µ–Ω “õ–∞“õ—Ç—ã“ì—ã—Å', tr:'Ev sahibiyle anla≈ümazlƒ±k'}, cls:''},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a friendly, knowledgeable legal rights assistant available to people in any country worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in. Russian ‚Üí Russian. English ‚Üí English. Turkish ‚Üí Turkish. Kazakh ‚Üí Kazakh. If mixed, use the dominant language.

LOCATION CONTEXT: The user appears to be in ${userCountryName} (${userCountry}). By default, apply laws of this country. However, if the user explicitly mentions another country or legal system (e.g., "according to Russian Labor Code" / "–ø–æ –¢–ö –†–§"), answer specifically for that country instead.

WEB SEARCH FOR LAWS: When citing specific laws, articles, or regulations, always search for the most current version. Format citations as:
<div class="tag law">üìú [Law name], Article [X] ¬∑ Last updated: [year] ¬∑ <a href="[official_url]" target="_blank">Source</a></div>

If the user uploads a document image, read it carefully and explain what it says and what they should do.

Format responses with HTML:
- <h4> for headings
- <ul><li> for lists
- Steps: <div class="step-row"><span class="sn">01</span><div>text</div></div>
- Deadlines: <div class="tag dl">‚è∞ –°—Ä–æ–∫: X –¥–Ω–µ–π</div>
- Info: <div class="tag inf">‚ÑπÔ∏è text</div>
- Always end with: <div class="disclaimer">–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —é—Ä–∏—Å—Ç—É.</div>`
  },

  doc: {
    sendCls:'g', inputCls:'fc', icon:'üìã',
    getTitle: () => UI_LANGS[uiLang].tabLabor,
    getWelcomeTitle: () => ({ ru:'–°–æ—Å—Ç–∞–≤–∏–º –¥–æ–∫—É–º–µ–Ω—Ç', en:"Let's Draft Your Document", kz:'“ö“±–∂–∞—Ç –∂–∞—Å–∞–π—ã“õ', tr:'Belgenizi Hazƒ±rlayalƒ±m' })[uiLang] || "Let's Draft",
    getWelcomeText: () => ({ ru:'–ü–æ–º–æ–≥—É –Ω–∞–ø–∏—Å–∞—Ç—å –ª—é–±—É—é –∂–∞–ª–æ–±—É, –∑–∞—è–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –ø–∏—Å—å–º–æ ‚Äî –≥–æ—Ç–æ–≤–æ–µ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –æ–±—ä—è—Å–Ω—é —á—Ç–æ –≤ –Ω—ë–º –Ω–∞–ø–∏—Å–∞–Ω–æ.', en:"I'll help you write any complaint, application or letter ‚Äî ready to send. Upload a document and I'll explain what it means.", kz:'–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —à–∞“ì—ã–º, ”©—Ç—ñ–Ω—ñ—à –Ω–µ–º–µ—Å–µ —Ö–∞—Ç –∂–∞–∑—É“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω. “ö“±–∂–∞—Ç –∂“Ø–∫—Ç–µ“£—ñ–∑ ‚Äî –º–µ–Ω –æ–Ω—ã —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä–µ–º—ñ–Ω.', tr:'Herhangi bir ≈üikayet, ba≈üvuru veya mektubu yazmanƒ±za yardƒ±mcƒ± olacaƒüƒ±m. Belge y√ºkleyin ‚Äî a√ßƒ±klayayƒ±m.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üìù', text:{ru:'–ù–∞–ø–∏—Å–∞—Ç—å –∂–∞–ª–æ–±—É –≤ –±–∞–Ω–∫', en:'Write a complaint to a bank', kz:'–ë–∞–Ω–∫–∫–µ —à–∞“ì—ã–º –∂–∞–∑—É', tr:'Bankaya ≈üikayet yaz'}, cls:''},
      {icon:'‚ö°', text:{ru:'–ü—Ä–µ—Ç–µ–Ω–∑–∏—è –Ω–∞ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä', en:'Complaint about defective product', kz:'–ê“õ–∞—É–ª—ã —Ç–∞—É–∞—Ä“ì–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏—è', tr:'Kusurlu √ºr√ºn ≈üikayeti'}, cls:'qg'},
      {icon:'üéì', text:{ru:'–ê–ø–æ—Å—Ç–∏–ª—å –∏ –ª–µ–≥–∞–ª–∏–∑–∞—Ü–∏—è', en:'Apostille & legalization', kz:'–ê–ø–æ—Å—Ç–∏–ª—å –∂”ô–Ω–µ –∑–∞“£–¥–∞—Å—Ç—ã—Ä—É', tr:'Apostil ve tasdik'}, cls:'qa'},
      {icon:'‚úâÔ∏è', text:{ru:'–ü–∏—Å—å–º–æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é', en:'Letter to employer', kz:'–ñ“±–º—ã—Å –±–µ—Ä—É—à—ñ–≥–µ —Ö–∞—Ç', tr:'ƒ∞≈üverene mektup'}, cls:''},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a document drafting assistant for everyday people in any country worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in.

LOCATION CONTEXT: The user appears to be in ${userCountryName} (${userCountry}). Apply local legal standards by default. If they specify another country, use that.

WEB SEARCH: When referencing specific legal requirements for documents, search for current requirements. Cite sources with:
<div class="tag law">üìú [Reference] ¬∑ <a href="[url]" target="_blank">Source</a></div>

Format with HTML:
- <h4> for headings
- Ready document: <div class="doc-block">document text here</div>
- Steps: <div class="step-row"><span class="sn g">01</span><div>text</div></div>
- <div class="tag ok">‚úì text</div>
- End with: <div class="disclaimer">–≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –Ω–æ—Å–∏—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —é—Ä–∏—Å—Ç—É.</div>`
  },

  rental: {
    sendCls:'', inputCls:'', icon:'üè†',
    getTitle: () => UI_LANGS[uiLang].tabRental,
    getWelcomeTitle: () => ({ ru:'–í–æ–ø—Ä–æ—Å—ã –∞—Ä–µ–Ω–¥—ã', en:'Rental Questions', kz:'–ñ–∞–ª–¥–∞–º –º”ô—Å–µ–ª–µ–ª–µ—Ä—ñ', tr:'Kiralƒ±k Sorular' })[uiLang] || 'Rental',
    getWelcomeText: () => ({ ru:'–ü–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –∏ –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è, —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã.', en:"I'll help you understand tenant and landlord rights, draft or review a rental agreement.", kz:'–ñ–∞–ª“ì–∞ –∞–ª—É—à—ã –º–µ–Ω –∂–∞–ª“ì–∞ –±–µ—Ä—É—à—ñ–Ω—ñ“£ “õ“±“õ—ã“õ—Ç–∞—Ä—ã–Ω —Ç“Ø—Å—ñ–Ω—É–≥–µ, –∂–∞–ª–¥–∞—É —à–∞—Ä—Ç—ã–Ω –∂–∞—Å–∞—É“ì–∞ –Ω–µ–º–µ—Å–µ —Ç–µ–∫—Å–µ—Ä—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.', tr:'Kiracƒ± ve ev sahibi haklarƒ±nƒ± anlamanƒ±za, kira s√∂zle≈ümesi hazƒ±rlamanƒ±za yardƒ±mcƒ± olacaƒüƒ±m.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üìÑ', text:{ru:'–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã', en:'Review rental contract', kz:'–ñ–∞–ª–¥–∞—É —à–∞—Ä—Ç—ã–Ω —Ç–µ–∫—Å–µ—Ä—É', tr:'Kira s√∂zle≈ümesini incele'}, cls:''},
      {icon:'üí∞', text:{ru:'–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ª–æ–≥', en:'Landlord not returning deposit', kz:'–ñ–∞–ª“ì–∞ –±–µ—Ä—É—à—ñ –∫–µ–ø—ñ–ª–¥—ñ “õ–∞–π—Ç–∞—Ä–º–∞–π–¥—ã', tr:'Ev sahibi depozitoyu iade etmiyor'}, cls:'qg'},
      {icon:'üîß', text:{ru:'–†–µ–º–æ–Ω—Ç ‚Äî –∫—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–ª–∞—Ç–∏—Ç—å?', en:'Repairs ‚Äî who should pay?', kz:'–ñ”©–Ω–¥–µ—É ‚Äî –∫—ñ–º —Ç”©–ª–µ—É—ñ –∫–µ—Ä–µ–∫?', tr:'Tamirat ‚Äî kim √∂demeli?'}, cls:''},
      {icon:'üìã', text:{ru:'–í—ã—Å–µ–ª–µ–Ω–∏–µ ‚Äî –º–æ–∏ –ø—Ä–∞–≤–∞', en:'Eviction ‚Äî my rights', kz:'–®—ã“ì–∞—Ä—ã–ø –∂—ñ–±–µ—Ä—É ‚Äî –º–µ–Ω—ñ“£ “õ“±“õ—ã“õ—Ç–∞—Ä—ã–º', tr:'Tahliye ‚Äî haklarƒ±m'}, cls:'qa'},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a rental law assistant for tenants and landlords worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in.
LOCATION CONTEXT: User is in ${userCountryName} (${userCountry}). Apply local rental law by default.
WEB SEARCH: Search for current rental laws and cite: <div class="tag law">üìú [Law] ¬∑ <a href="[url]" target="_blank">Source</a></div>
Format: <h4>, <ul><li>, step-row, tags. End with disclaimer.`
  },

  fines: {
    sendCls:'', inputCls:'', icon:'üöó',
    getTitle: () => UI_LANGS[uiLang].tabFines,
    getWelcomeTitle: () => ({ ru:'–®—Ç—Ä–∞—Ñ—ã –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è', en:'Fines & Violations', kz:'–ê–π—ã–ø–ø“±–ª–¥–∞—Ä', tr:'Cezalar ve ƒ∞hlaller' })[uiLang] || 'Fines',
    getWelcomeText: () => ({ ru:'–ü–æ–º–æ–≥—É –æ—Å–ø–æ—Ä–∏—Ç—å —à—Ç—Ä–∞—Ñ, —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∏–ª–∏ –ø–æ–Ω—è—Ç—å –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Å–∞–Ω–∫—Ü–∏–π.', en:"I'll help you appeal a fine, understand an administrative violation, or avoid sanctions.", kz:'–ê–π—ã–ø–ø“±–ª“ì–∞ –¥–∞—É –∞–π—Ç—É“ì–∞, ”ô–∫—ñ–º—à—ñ–ª—ñ–∫ –±“±–∑—É—à—ã–ª—ã“õ—Ç—ã —Ç“Ø—Å—ñ–Ω—É–≥–µ –Ω–µ–º–µ—Å–µ —Å–∞–Ω–∫—Ü–∏—è–ª–∞—Ä–¥–∞–Ω –∞—É–ª–∞“õ –±–æ–ª—É“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.', tr:'Para cezasƒ±na itiraz etmenize, idari ihlali anlamanƒ±za yardƒ±mcƒ± olacaƒüƒ±m.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üì∏', text:{ru:'–®—Ç—Ä–∞—Ñ —Å –∫–∞–º–µ—Ä—ã ‚Äî –∫–∞–∫ –æ—Å–ø–æ—Ä–∏—Ç—å', en:'Camera fine ‚Äî how to appeal', kz:'–ö–∞–º–µ—Ä–∞–¥–∞–Ω –∞–π—ã–ø–ø“±–ª ‚Äî “õ–∞–ª–∞–π –¥–∞—É–ª–∞—Å—É', tr:'Kamera cezasƒ± ‚Äî nasƒ±l itiraz edilir'}, cls:''},
      {icon:'‚úàÔ∏è', text:{ru:'–ë—ã–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π –∫–æ–≥–¥–∞ –≤—ã–ø–∏—Å–∞–ª–∏ —à—Ç—Ä–∞—Ñ', en:'Was abroad when fine was issued', kz:'–ê–π—ã–ø–ø“±–ª —à—ã“õ“õ–∞–Ω–¥–∞ —à–µ—Ç–µ–ª–¥–µ –±–æ–ª–¥—ã–º', tr:'Ceza kesildiƒüinde yurt dƒ±≈üƒ±ndaydƒ±m'}, cls:'qg'},
      {icon:'‚è±Ô∏è', text:{ru:'–ü—Ä–æ–ø—É—Å—Ç–∏–ª —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã —à—Ç—Ä–∞—Ñ–∞', en:'Missed fine payment deadline', kz:'–ê–π—ã–ø–ø“±–ª —Ç”©–ª–µ—É –º–µ—Ä–∑—ñ–º—ñ–Ω ”©—Ç–∫—ñ–∑–¥—ñ–º', tr:'Ceza √∂deme s√ºresini ka√ßƒ±rdƒ±m'}, cls:'qa'},
      {icon:'üìã', text:{ru:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å', en:'Administrative protocol ‚Äî what to do', kz:'”ò–∫—ñ–º—à—ñ–ª—ñ–∫ —Ö–∞—Ç—Ç–∞–º–∞ ‚Äî –Ω–µ —ñ—Å—Ç–µ—É –∫–µ—Ä–µ–∫', tr:'ƒ∞dari tutanak ‚Äî ne yapmalƒ±'}, cls:''},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a fines and administrative violations assistant worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in.
LOCATION CONTEXT: User is in ${userCountryName} (${userCountry}). Apply local law by default.
WEB SEARCH: Search for current fine amounts and appeal procedures. Cite: <div class="tag law">üìú [Law] ¬∑ <a href="[url]" target="_blank">Source</a></div>
Format: <h4>, steps, tags. End with disclaimer.`
  },

  banking: {
    sendCls:'', inputCls:'', icon:'üè¶',
    getTitle: () => UI_LANGS[uiLang].tabBanking,
    getWelcomeTitle: () => ({ ru:'–ë–∞–Ω–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã', en:'Banking & Finance', kz:'–ë–∞–Ω–∫—Ç–µ—Ä –º–µ–Ω “õ–∞—Ä–∂—ã', tr:'Bankacƒ±lƒ±k ve Finans' })[uiLang] || 'Banking',
    getWelcomeText: () => ({ ru:'–ü–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ —Å–ø–æ—Ä–∞–º–∏, –∫—Ä–µ–¥–∏—Ç–∞–º–∏, –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ–º –∏ –∑–∞—â–∏—Ç–æ–π –ø—Ä–∞–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —É—Å–ª—É–≥.', en:"I'll help with banking disputes, loans, fraud, and consumer rights in financial services.", kz:'–ë–∞–Ω–∫—Ç—ñ–∫ –¥–∞—É–ª–∞—Ä–¥—ã, –Ω–µ—Å–∏–µ–ª–µ—Ä–¥—ñ, –∞–ª–∞—è“õ—Ç—ã“õ—Ç—ã —à–µ—à—É–≥–µ –∂”ô–Ω–µ “õ–∞—Ä–∂—ã–ª—ã“õ “õ—ã–∑–º–µ—Ç —Ç“±—Ç—ã–Ω—É—à—ã—Å—ã–Ω—ã“£ “õ“±“õ—ã“õ—Ç–∞—Ä—ã–Ω “õ–æ—Ä“ì–∞—É“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.', tr:'Bankacƒ±lƒ±k anla≈ümazlƒ±klarƒ±, krediler, dolandƒ±rƒ±cƒ±lƒ±k ve finansal t√ºketici haklarƒ± konusunda yardƒ±mcƒ± olacaƒüƒ±m.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üîí', text:{ru:'–ë–∞–Ω–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —Å—á—ë—Ç', en:'Bank blocked my account', kz:'–ë–∞–Ω–∫ —à–æ—Ç—ã–º–¥—ã –±“±“ì–∞—Ç—Ç–∞–¥—ã', tr:'Banka hesabƒ±mƒ± bloke etti'}, cls:''},
      {icon:'üí≥', text:{ru:'–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ —Å –∫–∞—Ä—Ç–æ–π', en:'Credit card fraud', kz:'–ö–∞—Ä—Ç–∞–º–µ–Ω –∞–ª–∞—è“õ—Ç—ã“õ', tr:'Kart dolandƒ±rƒ±cƒ±lƒ±ƒüƒ±'}, cls:'qg'},
      {icon:'üìä', text:{ru:'–ë–∞–Ω–∫ –Ω–∞–≤—è–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏', en:'Bank imposing unwanted services', kz:'–ë–∞–Ω–∫ “õ—ã–∑–º–µ—Ç—Ç–µ—Ä–¥—ñ –º”ô–∂–±“Ø—Ä–ª–µ–π–¥—ñ', tr:'Banka hizmetleri dayatƒ±yor'}, cls:''},
      {icon:'üí∞', text:{ru:'–°–ø–æ—Ä –ø–æ –∫—Ä–µ–¥–∏—Ç—É', en:'Loan dispute', kz:'–ù–µ—Å–∏–µ –±–æ–π—ã–Ω—à–∞ –¥–∞—É', tr:'Kredi anla≈ümazlƒ±ƒüƒ±'}, cls:'qa'},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a banking and financial rights assistant worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in.
LOCATION CONTEXT: User is in ${userCountryName} (${userCountry}). Apply local banking laws and regulations.
WEB SEARCH: Search for current banking regulations and consumer protection laws. Cite sources.
Format: <h4>, steps, tags. End with disclaimer.`
  },

  consumer: {
    sendCls:'', inputCls:'', icon:'üë§',
    getTitle: () => UI_LANGS[uiLang].tabConsumer,
    getWelcomeTitle: () => ({ ru:'–ü—Ä–∞–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è', en:'Consumer Rights', kz:'–¢“±—Ç—ã–Ω—É—à—ã “õ“±“õ—ã“õ—Ç–∞—Ä—ã', tr:'T√ºketici Haklarƒ±' })[uiLang] || 'Consumer Rights',
    getWelcomeText: () => ({ ru:'–ü–æ–º–æ–≥—É —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Ç–æ–≤–∞—Ä–∞, –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–æ–º, –∑–∞—â–∏—Ç–æ–π –ø—Ä–∞–≤ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞—Ö –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.', en:"I'll help with product returns, warranty repairs, and consumer protection for online and offline purchases.", kz:'–¢–∞—É–∞—Ä–¥—ã “õ–∞–π—Ç–∞—Ä—É–º–µ–Ω, –∫–µ–ø—ñ–ª–¥—ñ–∫—Ç—ñ –∂”©–Ω–¥–µ—É–º–µ–Ω, –æ–Ω–ª–∞–π–Ω –∂”ô–Ω–µ –æ—Ñ–ª–∞–π–Ω —Å–∞—Ç—ã–ø –∞–ª—É–ª–∞—Ä–¥–∞“ì—ã —Ç“±—Ç—ã–Ω—É—à—ã “õ“±“õ—ã“õ—Ç–∞—Ä—ã–Ω “õ–æ—Ä“ì–∞—É–º–µ–Ω –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.', tr:'√úr√ºn iade, garanti tamiri ve online/offline alƒ±≈üveri≈ülerde t√ºketici haklarƒ±yla ilgili yardƒ±mcƒ± olacaƒüƒ±m.' })[uiLang] || '',
    getQuick: () => ([
      {icon:'üì¶', text:{ru:'–•–æ—á—É –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä', en:'Want to return a product', kz:'–¢–∞—É–∞—Ä–¥—ã “õ–∞–π—Ç–∞—Ä“ì—ã–º –∫–µ–ª–µ–¥—ñ', tr:'√úr√ºn iade etmek istiyorum'}, cls:''},
      {icon:'üîß', text:{ru:'–û—Ç–∫–∞–∑—ã–≤–∞—é—Ç –≤ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–º —Ä–µ–º–æ–Ω—Ç–µ', en:'Refusing warranty repair', kz:'–ö–µ–ø—ñ–ª–¥—ñ–∫—Ç—ñ –∂”©–Ω–¥–µ—É–¥–µ–Ω –±–∞—Å —Ç–∞—Ä—Ç–∞–¥—ã', tr:'Garanti tamirini reddediyorlar'}, cls:'qg'},
      {icon:'üõí', text:{ru:'–û–±–º–∞–Ω –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–µ', en:'Online shop fraud', kz:'–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥“Ø–∫–µ–Ω–¥–µ–≥—ñ –∞–ª–¥–∞—É', tr:'Online maƒüaza dolandƒ±rƒ±cƒ±lƒ±ƒüƒ±'}, cls:''},
      {icon:'üìã', text:{ru:'–ñ–∞–ª–æ–±–∞ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥', en:'Complaint about service quality', kz:'“ö—ã–∑–º–µ—Ç —Å–∞–ø–∞—Å—ã–Ω–∞ —à–∞“ì—ã–º', tr:'Hizmet kalitesi ≈üikayeti'}, cls:'qa'},
    ]),
    getSystem: () => `You are Dost AI ‚Äî a consumer rights assistant worldwide.

CRITICAL LANGUAGE RULE: Always respond in the SAME language the user writes in.
LOCATION CONTEXT: User is in ${userCountryName} (${userCountry}). Apply local consumer protection laws.
WEB SEARCH: Search for current consumer protection laws. Cite: <div class="tag law">üìú [Law] ¬∑ <a href="[url]" target="_blank">Source</a></div>
Format: <h4>, steps, tags. End with disclaimer.`
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cur = 'lex';
let messages = [];
let pendingImageBase64 = null;
let pendingImageName = '';
let pendingMediaType = 'image/jpeg';
let pendingTextContent = null;
let currentUser = null;
let chatHistory = []; // [{id, title, messages, date, module}]

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchModule(mod, tabEl) {
  cur = mod;
  messages = [];
  pendingImageBase64 = null;
  pendingTextContent = null;
  document.getElementById('imgPreview').classList.remove('visible');

  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');

  const m = mods[mod];
  document.getElementById('sendBtn').className = 'send-btn ' + m.sendCls;
  document.getElementById('inputRow').className = 'input-row ' + m.inputCls;

  renderWelcome();
}

function renderWelcome() {
  const m = mods[cur];
  const t = UI_LANGS[uiLang];
  const quickItems = m.getQuick();
  document.getElementById('chatMessages').innerHTML = `
    <div class="welcome">
      <div class="welcome-emoji">${m.icon}</div>
      <h2>${m.getWelcomeTitle()}</h2>
      <p>${m.getWelcomeText()}</p>
      <div class="location-pill">üìç ${userCountryName} ¬∑ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
      <div class="quick-grid">
        ${quickItems.map(q=>`
          <div class="quick-card ${q.cls}" onclick="askQuick('${(q.text[uiLang]||q.text.ru).replace(/'/g,"\\'")}')">
            <div class="qc-icon">${q.icon}</div>
            <div class="qc-text">${q.text[uiLang]||q.text.ru}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function askQuick(text) {
  document.getElementById('msgInput').value = text;
  sendMsg();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleHistory() {
  const panel = document.getElementById('historyPanel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) renderHistory();
}

function renderHistory() {
  const t = UI_LANGS[uiLang];
  const content = document.getElementById('historyContent');

  // Load from localStorage
  const stored = JSON.parse(localStorage.getItem('dost_history') || '[]');
  chatHistory = stored;

  if (stored.length === 0) {
    content.innerHTML = `
      <div class="history-empty">${t.historyEmpty}</div>
      ${!currentUser ? `<div class="history-login-prompt">
        ${t.historyLoginPrompt}<br><br>
        <a onclick="openAuth('login')">${t.historyLoginLink}</a>
      </div>` : ''}
    `;
    return;
  }

  content.innerHTML = stored.map((item, i) => `
    <div class="history-item" onclick="loadChat(${i})">
      <div class="history-item-title">${item.title}</div>
      <div class="history-item-date">${item.date}</div>
    </div>
  `).join('');
}

function saveCurrentChat() {
  if (messages.length < 2) return;
  const firstMsg = messages[0]?.content || '';
  const title = typeof firstMsg === 'string' ? firstMsg.slice(0,50) : '–ù–æ–≤—ã–π —á–∞—Ç';
  const date = new Date().toLocaleDateString(uiLang === 'en' ? 'en-US' : 'ru-RU', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});

  const stored = JSON.parse(localStorage.getItem('dost_history') || '[]');
  stored.unshift({ title, date, messages: messages.slice(), module: cur });
  if (stored.length > 50) stored.pop(); // keep last 50
  localStorage.setItem('dost_history', JSON.stringify(stored));
}

function loadChat(index) {
  const stored = JSON.parse(localStorage.getItem('dost_history') || '[]');
  const item = stored[index];
  if (!item) return;

  cur = item.module || 'lex';
  messages = item.messages || [];

  // Switch tab
  document.querySelectorAll('.tab[data-mod]').forEach(t => {
    t.classList.toggle('active', t.getAttribute('data-mod') === cur);
  });

  // Render messages
  const chat = document.getElementById('chatMessages');
  chat.innerHTML = '';
  messages.forEach(msg => {
    addMsg(msg.role === 'user' ? 'user' : 'ai', msg.content);
  });

  document.getElementById('historyPanel').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://qepnxzgwggovmeqdapgw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_lkwXPgKj0ztFR3n-UmiVbw_SYLJJegM';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Check session on load
_supabase.auth.getSession().then(({ data: { session } }) => {
  if (session?.user) onUserLoggedIn(session.user);
});

// Listen for auth state changes
_supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' && session?.user) {
    onUserLoggedIn(session.user);
    closeAuth();
  }
  if (event === 'SIGNED_OUT') onUserLoggedOut();
});

function onUserLoggedIn(user) {
  currentUser = user;
  const name = user.user_metadata?.full_name || user.email.split('@')[0];
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.textContent = name;
  loginBtn.onclick = async () => {
    await _supabase.auth.signOut();
  };
  document.getElementById('registerBtn').style.display = 'none';
}

function onUserLoggedOut() {
  currentUser = null;
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.textContent = UI_LANGS[uiLang]?.login || '–í–æ–π—Ç–∏';
  loginBtn.onclick = () => openAuth('login');
  document.getElementById('registerBtn').style.display = '';
}

function openAuth(tab) {
  document.getElementById('authModal').classList.add('open');
  switchAuthTab(tab || 'login');
}

function closeAuth() {
  document.getElementById('authModal').classList.remove('open');
  const el = document.getElementById('authError');
  if (el) el.remove();
}

function switchAuthTab(tab) {
  document.getElementById('formLogin').style.display = tab === 'login' ? 'flex' : 'none';
  document.getElementById('formRegister').style.display = tab === 'register' ? 'flex' : 'none';
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
  const el = document.getElementById('authError');
  if (el) el.remove();
}

document.getElementById('authModal').addEventListener('click', function(e) {
  if (e.target === this) closeAuth();
});

function showAuthError(msg) {
  let el = document.getElementById('authError');
  if (!el) {
    el = document.createElement('div');
    el.id = 'authError';
    el.style.cssText = 'color:#c0392b;font-size:12px;text-align:center;padding:8px 12px;background:rgba(192,57,43,0.08);border-radius:8px;font-family:"IBM Plex Mono",monospace;';
    const activeForm = document.getElementById('formLogin').style.display !== 'none'
      ? document.getElementById('formLogin')
      : document.getElementById('formRegister');
    activeForm.appendChild(el);
  }
  el.textContent = msg;
}

async function authWithGoogle() {
  const { error } = await _supabase.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.origin + window.location.pathname }
  });
  if (error) showAuthError(error.message);
}

async function authWithEmail(type) {
  const email = document.getElementById(type === 'login' ? 'loginEmail' : 'regEmail').value.trim();
  const pass = document.getElementById(type === 'login' ? 'loginPassword' : 'regPassword').value;

  if (!email || !pass) return showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  if (pass.length < 6) return showAuthError('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');

  const btn = document.querySelector(
    `#form${type === 'login' ? 'Login' : 'Register'} .btn-submit`
  );
  const origText = btn.textContent;
  btn.textContent = '...';
  btn.disabled = true;

  let result;
  if (type === 'login') {
    result = await _supabase.auth.signInWithPassword({ email, password: pass });
  } else {
    result = await _supabase.auth.signUp({ email, password: pass });
    if (!result.error) {
      btn.textContent = origText;
      btn.disabled = false;
      showAuthError('‚úì –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º email –∏ –ø–∞—Ä–æ–ª–µ–º.');
      switchAuthTab('login');
      return;
    }
  }

  btn.textContent = origText;
  btn.disabled = false;

  if (result.error) {
    const msg = result.error.message.includes('Invalid login credentials') ? '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
      : result.error.message.includes('already registered') ? 'Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'
      : result.error.message.includes('Email not confirmed') ? '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email'
      : result.error.message;
    showAuthError(msg);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FILE_TYPES = {
  image:   { exts: ['jpg','jpeg','png','gif','webp'], icon: 'üñºÔ∏è', label: 'IMAGE', mode: 'image' },
  pdf:     { exts: ['pdf'],                           icon: 'üìÑ', label: 'PDF',   mode: 'pdf' },
  word:    { exts: ['doc','docx'],                    icon: 'üìù', label: 'WORD',  mode: 'text' },
  excel:   { exts: ['xls','xlsx'],                    icon: 'üìä', label: 'EXCEL', mode: 'text' },
  ppt:     { exts: ['ppt','pptx'],                    icon: 'üìë', label: 'PPT',   mode: 'text' },
  txt:     { exts: ['txt'],                           icon: 'üìÉ', label: 'TXT',   mode: 'text' },
};

function getFileType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  for (const [key, val] of Object.entries(FILE_TYPES)) {
    if (val.exts.includes(ext)) return { key, ...val };
  }
  return { key:'unknown', icon:'üìé', label:'FILE', mode:'text' };
}

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';

  const ftype = getFileType(file.name);
  pendingImageName = file.name;
  pendingTextContent = null;
  pendingImageBase64 = null;

  const svgIcon = (icon) => `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52"><rect width="52" height="52" rx="8" fill="%23c8922a" opacity="0.12"/><text x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" font-size="28">' + icon + '</text></svg>')}`;

  function showPreview(thumbSrc) {
    document.getElementById('imgPreviewThumb').src = thumbSrc;
    document.getElementById('imgPreviewName').textContent = file.name;
    document.getElementById('imgPreviewSub').textContent = `${ftype.icon} ${ftype.label} ATTACHED ¬∑ AI WILL READ IT`;
    document.getElementById('imgPreview').classList.add('visible');
  }

  if (ftype.mode === 'image') {
    pendingMediaType = file.type || 'image/jpeg';
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      pendingImageBase64 = dataUrl.split(',')[1];
      showPreview(dataUrl);
    };
    reader.readAsDataURL(file);
  } else if (ftype.mode === 'pdf') {
    pendingMediaType = 'application/pdf';
    const reader = new FileReader();
    reader.onload = ev => {
      pendingImageBase64 = ev.target.result.split(',')[1];
      showPreview(svgIcon('üìÑ'));
    };
    reader.readAsDataURL(file);
  } else if (ftype.key === 'word') {
    const arrayBuf = await file.arrayBuffer();
    try {
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuf });
      pendingTextContent = result.value.slice(0, 8000);
      pendingMediaType = 'text';
      showPreview(svgIcon('üìù'));
    } catch(err) { alert('Could not read Word file.'); }
  } else if (ftype.key === 'excel') {
    const arrayBuf = await file.arrayBuffer();
    try {
      const wb = XLSX.read(arrayBuf, { type: 'array' });
      let text = '';
      wb.SheetNames.forEach(name => {
        text += `[Sheet: ${name}]\n` + XLSX.utils.sheet_to_csv(wb.Sheets[name]) + '\n\n';
      });
      pendingTextContent = text.slice(0, 8000);
      pendingMediaType = 'text';
      showPreview(svgIcon('üìä'));
    } catch(err) { alert('Could not read Excel file.'); }
  } else if (ftype.key === 'ppt') {
    const arrayBuf = await file.arrayBuffer();
    try {
      const wb = XLSX.read(arrayBuf, { type: 'array' });
      let text = wb.SheetNames.map(n => XLSX.utils.sheet_to_csv(wb.Sheets[n])).join('\n');
      pendingTextContent = ('[PowerPoint: ' + file.name + ']\n' + text).slice(0, 8000);
      pendingMediaType = 'text';
      showPreview(svgIcon('üìë'));
    } catch(err) {
      pendingTextContent = `[PowerPoint attached: ${file.name}]`;
      pendingMediaType = 'text';
      showPreview(svgIcon('üìë'));
    }
  } else if (ftype.key === 'txt') {
    const text = await file.text();
    pendingTextContent = text.slice(0, 8000);
    pendingMediaType = 'text';
    showPreview(svgIcon('üìÉ'));
  }
}

function removeImage() {
  pendingImageBase64 = null;
  pendingImageName = '';
  pendingMediaType = 'image/jpeg';
  pendingTextContent = null;
  document.getElementById('imgPreview').classList.remove('visible');
  document.getElementById('imgPreviewThumb').src = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addMsg(role, html, imgSrc) {
  const chat = document.getElementById('chatMessages');
  const w = chat.querySelector('.welcome');
  if (w) w.remove();

  const div = document.createElement('div');
  div.className = 'msg ' + role;
  const av = role === 'ai' ? mods[cur].icon : 'D';
  const imgHtml = (imgSrc && role === 'user') ? `<img src="${imgSrc}" alt="document">` : '';
  div.innerHTML = `<div class="avatar">${av}</div><div class="bubble">${imgHtml}${html}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addTyping() {
  const chat = document.getElementById('chatMessages');
  const w = chat.querySelector('.welcome');
  if (w) w.remove();
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'typing-el';
  div.innerHTML = `<div class="avatar">${mods[cur].icon}</div><div class="bubble"><div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEND MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMsg() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text && !pendingImageBase64) return;

  const isPDF = pendingMediaType === 'application/pdf';
  const isImage = pendingImageBase64 && !isPDF;
  const isTextFile = pendingTextContent !== null;
  const hasFile = isPDF || isImage || isTextFile;

  const imgSrc = isImage ? `data:${pendingMediaType};base64,` + pendingImageBase64 : null;

  let fileLabel = '';
  if (isPDF) fileLabel = 'üìÑ PDF attached';
  else if (isImage) fileLabel = 'üñºÔ∏è Image attached';
  else if (isTextFile) fileLabel = `üìé ${pendingImageName} attached`;

  const displayText = text || (hasFile ? fileLabel + ' ‚Äî please read and explain' : '');
  if (!displayText) return;

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('sendBtn').disabled = true;

  addMsg('user', displayText, imgSrc);

  // Build API content
  let userContent;
  if (isPDF && pendingImageBase64) {
    userContent = [
      { type:'document', source:{ type:'base64', media_type:'application/pdf', data:pendingImageBase64 } },
      { type:'text', text: text || 'Please read this document carefully and explain what it says and what I should do.' }
    ];
  } else if (isImage) {
    userContent = [
      { type:'image', source:{ type:'base64', media_type: pendingMediaType, data:pendingImageBase64 } },
      { type:'text', text: text || 'Please read this document carefully and explain what it says and what I should do.' }
    ];
  } else if (isTextFile) {
    const filePrompt = text
      ? `${text}\n\n[File: ${pendingImageName}]\n${pendingTextContent}`
      : `Please read this file and explain what it says.\n\n[File: ${pendingImageName}]\n${pendingTextContent}`;
    userContent = filePrompt;
  } else {
    userContent = text;
  }

  const historyContent = text || 'I uploaded a document for you to read and explain.';
  messages.push({ role:'user', content: historyContent });

  removeImage();
  addTyping();

  try {
    const requestMessages = [
      ...messages.slice(0, -1),
      { role:'user', content: userContent }
    ];

    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        system: mods[cur].getSystem(),
        messages: requestMessages
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);
    const reply = data.content?.[0]?.text || 'No response received.';

    messages.push({ role:'assistant', content: reply });
    document.getElementById('typing-el')?.remove();
    addMsg('ai', reply);

    // Auto-save to localStorage
    saveCurrentChat();

  } catch(e) {
    document.getElementById('typing-el')?.remove();
    addMsg('ai',`<p style="color:var(--muted)">‚ö†Ô∏è –û—à–∏–±–∫–∞: ${e.message || 'Connection failed'}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</p>`);
    messages.pop();
  }

  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderWelcome();
</script>
</body>
</html>
